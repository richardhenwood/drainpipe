<!-- 
    Project Drainpipe: A RESTful sound tracker
    Copyright (C) 2012,2013  Richard Henwood rjhenwood@yahoo.co.uk

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
    <meta charset="UTF-8">
    <script language='javascript' src="https://raw.github.com/oampo/audiofile.js/master/audiofile.js"></script>

    <style type="text/css">
        div {
            padding: 2px;
            margin-top: 20px;
        }
        #debug {
            background-color: yellow;
            width: 100px;
            float: left;
        }
        #title {
            height: 20px;
        }
        #working {
            display: inline-block;
            width: 140px;
        }
        #patterns {
            width: 100%;
            float: left;
            background-color: #ddddff;
            display: block;
        }
        #patterns table {
            border: 0px;
            #width: 100%;
        }
        #patterns tr td {
            padding-top: 0px;
            padding-bottom: 0px;
            padding-right: 0px;
            padding-left: 0px;
            border: 0;
        }
        #patterns input {
            padding-top: 0px;
            padding-bottom: 0px;
            padding-right: 0px;
            padding-left: 0px;
            border: 20;
            height: 20px;
        }
        #pat_sel_box {
            display: none;
            position: absolute;
            border: 1px solid #000000;
            background: transparent;
            width: 0;
            height: 0;
        }
        #rendercontrols {
            background-color: #88ff00;
            float: left;
            width: 100px;
        }
        #tuneBrowser {
            width: 200px;
            float: left;
            background-color: #00ff00;
        }
        #documentation {
            width: 100%;
            display: block;
            float: left;
        }       
        #trackerUI {
            width: 100%;
            height: 500px;
            display: block;
            float: left;
        }       
        #instruments {
            width: 700px;
            float: left;
            display: block;
            background-color: #ffdddd;
            height: 200px;
        }
        #instrumentView {
            margin-top: -10px;
            width: 290px;
            float: left;
            overflow: auto;
            height: 200px;
        }
        #patternView {
            width: 100%;
            float: left;
            display: block;
            overflow: auto;
            /*height: 400px;*/
        }
        #sampleView {
            margin-top: -20px;
            width: 400px;
            float: right;
            overflow: auto;
            height: 200px;
            background-color: #ffcccc;
        }
        #tuneMetadata {
            width: 250px;
            float: left;
            background-color: #ff88ff;
        }
        .spanlabel {
            #border: 1px solid gray;
            display: inline-block;
            left: 10px;
            position: relative;
            top: -20px;
            background-color: inherit;
        }
        .note {
            color: purple;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .inst {
            color: green;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .instClass {
            margin-top: 0px;
        }
        .vol {
            color: yellow;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .eff {
            color: black;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .effval {
            color: red;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .but {
            background-color: #ffddff;
            border: 0px;
            padding: 0px;
        }
        .patternSelector {
            background-color: #ddffdd;
            border: 5px;
            padding: 5px;
        }
  </style>

    <script type="text/javascript">
        function init() {
            console.log("init'ing Neuralyte Tracker");
        }

        function load(evt) {
            nt.handleFileSelect(evt);
            console.log("loading Neuralyte Tracker");
        }

        var neuralyteTracker = (function() {
            jsong = null;
            //var jsong = null; //uncomment this to make it private
            var readURL = null;
            var xmlhttp = new XMLHttpRequest();
            var targetpath = null;
            var apiName = "";
            var apiRoot = document.location.href.split("#")[0];
            var writeRoot = document.location.href.split("#")[0];
            var readRoot = document.location.href.split("#")[0];
            var NOTES = ["..", "C-", "C#", "D-", "D#", "E-", "F-","F#", "G-", "G#", "A-", "A#", "B-"];

            return {
                init: function() {
                    if (window.File && window.FileReader && window.FileList && window.Blob) {
                        // Great success! All the File APIs are supported.
                        console.log('The File APIs are fully supported in this browser.');
                        document.getElementById('files').addEventListener('change', handleFileSelect, false);
                    } else {
                        alert('The File APIs are not fully supported in this browser.');
                    }
                },
                new: function() {
                    startWorking();
                    newRoot = apiRoot+"/new/new";
                    xmlhttp.open('GET', newRoot, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        console.log("new jsong created");
                        console.log(xmlhttp.responseText);
                        targetpath = eval("("+xmlhttp.responseText+")").saveLocation;
                        jsong = null;
                    }
                    else {
                        console.log("can not create new jsong");
                    }
                    document.getElementById('loadURL').value = targetpath;
                    this.load('loadURL');
                    console.log("load complete");
                    stopWorking();
                },
                load: function(id) {
                    startWorking();
                    readURL = document.getElementById(id).value;
                    console.log("loading: " + readURL);  
                    targetpath = readURL;
                    apiName = encodeURIComponent(readURL);
                    readRoot = apiRoot+"/"+apiName+"";
                    xmlhttp.open('GET', readRoot, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        jsong = eval("("+xmlhttp.responseText+")");
                    }
                    else {
                        console.log("can't load");
                    }
                    console.log("load complete");
                    stopWorking();
                    updateUI(jsong);
                },
                save: function() {
                    if (targetpath.match('iriscouch.com/') == null) {
                        alert("Cannot save this tune. Only iriscouch saving supported. Try 'save a copy' instead.");
                    }
                    else {
                        var docStore = document.getElementById('docStore').value;
                        if (docStore == "") {
                            alert("you need to specify a docstore.");
                        }
                        else {
                            startWorking();
                            docStore = encodeURIComponent(docStore);
                            var storeURL = apiRoot+"/" + docStore + "/save";
                            console.log("saving: " + storeURL);  
                            xmlhttp.open('GET', storeURL, false); 
                            xmlhttp.send(null);
                            if(xmlhttp.status == 200) {
                                console.log(xmlhttp.responseText);
                                var tmpRes = eval("("+xmlhttp.responseText+")");
                                targetpath = tmpRes.saveLocation;
                                jsong._rev = tmpRes._rev;
                            }
                            else {
                                console.log("can not create new jsong");
                            }
                            stopWorking();
                        }
                    }
                },
                savecopy: function(storeURL) {
                    var docStore = document.getElementById('docStore').value;
                    if (docStore == "") {
                        alert("you need to specify a docstore.");
                    }
                    else {
                        startWorking();
                        docStore = encodeURIComponent(docStore);
                        var storeURL = apiRoot+"/" + apiName + "/savecopy/" + docStore;
                        console.log("saving: " + storeURL);  
                        xmlhttp.open('GET', storeURL, false); 
                        //xmlhttp.send(JSON.stringify(jsong));
                        xmlhttp.send(null);
                        if(xmlhttp.status == 200) {
                            console.log(xmlhttp.responseText);
                            var tmpRes = eval("("+xmlhttp.responseText+")");
                            targetpath = tmpRes.saveLocation;
                            jsong._id = tmpRes._id;
                            jsong._rev = tmpRes._rev;
                            apiName = encodeURIComponent(targetpath);
                        }
                        else {
                            console.log("can not create new jsong");
                        }
                        stopWorking();
                    }
                },
                saveJsong: function() {
                    window.open( "data:text/json;charset=utf-8," + escape(JSON.stringify(jsong)))
                },
                play: function() {
                    var playURL = apiRoot+"/" + apiName + "/play";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("playing: " + playURL);  
                },
                pause: function() {
                    var playURL = apiRoot+"/" + apiName + "/stop";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("stopped: " + playURL);  
                },
                restart: function() {
                    var playURL = apiRoot+"/" + apiName + "/restart";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("stopped: " + playURL);  
                },
                loopPattern: function(evt, patNo) {
                    var loopUri = apiRoot+'/' + apiName + "/pattern/" + patNo + "/play";
                    xmlhttp.open('GET', loopUri, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log(loopUri);      
                },
                updateUI: function() {
                    startWorking();
                    updateUI(jsong);
                    stopWorking();
                },
                getStatus: function() {
                    var statusUri = apiRoot+'/' + apiName + "/status";
                    xmlhttp.open('GET', statusUri, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log(statusUri);      
                    currentStatus = eval("("+xmlhttp.responseText+")");
                },
                updateJsong: function(evt) {
                   //if (evt.keyCode == 13) { // 13 == enter.
                       jsong[evt.target.id] = document.getElementById(evt.target.id).value;
                       if (evt.target.id == 'sequence') {
                           console.log('making sequence an array');
                           jsong[evt.target.id] = eval('['+jsong[evt.target.id]+']');
                       }
                       neuralyteTracker.putJsong();
                   //}
                },
                getJsong: function() {
                    startWorking();
                    var getJsongURL = apiRoot+"/" + apiName + "/jsong";
                    xmlhttp.open('GET', getJsongURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        console.log(getJsongURL);      
                        jsong = eval("("+xmlhttp.responseText+")");
                    }
                    stopWorking();
                },
                putJsong: function() {
                    startWorking();
                    var putJsongURL = apiRoot+"/" + apiName + "/jsong";
                    xmlhttp.open('POST', putJsongURL, false); 
                    xmlhttp.send(JSON.stringify(jsong));
                    if(xmlhttp.status == 200)
                        console.log(putJsongURL);      
                    jsongglobals = eval("("+xmlhttp.responseText+")");
                    console.log(jsongglobals);
                    stopWorking();
                },
                renderInstrument: function(instNo) {
                    var inst = jsong.instruments[instNo];
                    if (typeof inst == 'undefined') {
                        inst = jsong.instruments[0];
                        inst.samples = Array(newSample(null, 'new sample'));
                        jsong.instruments[instNo] = inst;
                    }
                    console.log(inst);
                    var instSpan = document.getElementById('inst_'+instNo);
                    var sampView = document.getElementById('sampleView');
                    if (inst.samples.length == 0) {
                        this.renderSample(instNo, 0);
                    }
                    else {
                        for (var i = 0; i < inst.samples.length; i += 1) {
                            console.log('rendering sample: ' + i);
                            this.renderSample(instNo, i);
                        }
                    }
                },
                renderSample: function(instNo, sampNo) {
                    var samp = jsong.instruments[instNo].samples[sampNo];
                    var sampView = document.getElementById('sampleView');
                    while (sampView.hasChildNodes()) {
                        sampView.removeChild(sampView.lastChild);
                    }
                    var sampSpan = document.createElement('span');
                    sampSpan.id = 'samp_'+instNo+'_'+sampNo;
                    sampView.appendChild(sampSpan);

                    if (!('sampleData' in samp)) {
                        console.log('no sample data, initializing.');
                        var initSize = 1000;
                        samp.sampleData = new Array(initSize);
                        while (--initSize >= 0) {
                            samp.sampleData[initSize] = 0;
                        }

                    }
                    var sampCanvas = document.createElement('canvas');
                    sampCanvas.setAttribute('height', 100);
                    sampCanvas.setAttribute('width', 300);
                    sampCanvas.id = 'samp_' + instNo + '_'+sampNo + '_canvas';
                    sampSpan.appendChild(sampCanvas);
                    drawSample(sampCanvas.getContext('2d'), samp.sampleData);

                    var sampUpload = document.createElement('input');
                    sampUpload.id = 'samp_'+instNo+'_'+sampNo+'_upload';
                    sampUpload.type = 'file';
                    sampUpload.onchange = loadWavFile;

                    var relNoteText = document.createTextNode("relNote");
                    var relNote = document.createElement('input');
                    relNote.value = samp.relNote;
                    relNote.size = 5;
                    relNote.onchange = (function(x) {
                            // this updates the server with the new values.
                            samp.relNote = parseInt(x.target.value);
                            var n = x.target.parentElement.id.split('_'); 
                            console.log(samp);
                            neuralyteTracker.putSample(n[1], n[2], jsong.instruments[n[1]].samples[n[2]]);
                    });
                    var c2RateText = document.createTextNode("c2Rate");
                    var c2Rate = document.createElement('input');
                    c2Rate.value = samp.c2Rate;
                    c2Rate.size = 5;
                    c2Rate.onchange = (function(x) {
                            // this updates the server with the new values.
                            samp.c2Rate = parseInt(x.target.value);
                            var n = x.target.parentElement.id.split('_'); 
                            console.log(jsong);
                            neuralyteTracker.putSample(n[1], n[2], jsong.instruments[n[1]].samples[n[2]]);
                    });

                    sampSpan.appendChild(sampUpload);
                    sampSpan.appendChild(relNoteText);
                    sampSpan.appendChild(relNote);
                    sampSpan.appendChild(c2RateText);
                    sampSpan.appendChild(c2Rate);

                    console.log('sample data is ready for drawing.');
                },
                addNewPattern: function(evt) {
                    var numRows = parseInt(prompt("number of rows", 64));
                    var pat = null;
                    try {
                        pat = new newPattern(jsong.numChannels, numRows, jsong.patterns.length);
                    }
                    catch (ex) {
                        load();
                        pat = new newPattern(jsong.numChannels, numRows, jsong.patterns.length);
                    }
                    jsong.patterns[jsong.patterns.length] = pat;
                    updateUI(jsong);
                },
                addNewInstrument: function(evt) {
                    var inst = Object.create(jsong.instruments[0]);
                    inst.name = prompt("instrument name", "");
                    inst.samples = Array(newSample(null, 'new sample'));
                    jsong.instruments[jsong.instruments.length] = inst;
                    updateUI(jsong);
                },
                renderPattern: function(evt, patNo) {
                    var pat = jsong.patterns[patNo];
                    // there is a span already in the pattern
                    // dom object because one is created 
                    // in the 'private' method 'updateUI'.
                    // This design is terriable and should be
                    // fixed.
                    if (typeof pat == 'undefined') {
                        pat = newPattern(jsong.numChannels, jsong.patterns[0].numRows, patNo);
                        jsong.patterns[patNo] = pat;
                    }
                    var patSpan = document.getElementById('pat_' + patNo);
                    console.log("rendering pattern: " + patNo);
                    var numRowstext = document.createTextNode("number of rows");
                    var numRows = document.createElement('input');
                    numRows.value = pat.numRows;
                    numRows.size = 5;
                    numRows.onchange = (function(x) {
                            // this updates the server with the new values.
                            pat.numRows = parseInt(x.target.value);
                            var n = x.target.parentElement.id.split('_'); 
                            console.log(jsong);
                            neuralyteTracker.putPattern(patNumber, pat);
                    });
                    var patTable = document.createElement('table');
                    patTable.id = "pat_"+patNo+"_table";
                    for (var row = 0; row < pat.numRows; row += 1) {
                        var tr = document.createElement('tr');
                        var rowtd = document.createElement('td');
                        rowtd.class = 'pat_row';
                        rowtd.innerHTML = row.toString(16);
                        tr.appendChild(rowtd);
                        for (var chan = 0; chan < jsong.numChannels; chan += 1) { 
                            var td = getRow(patNo, pat, row, chan, jsong.numChannels);
                            td.id = "cell_"+ patNo+ "_" + row + "_" + chan;
                            td.onchange = this.noteChange;
                            tr.appendChild(td);
                        }
                        patTable.appendChild(tr);
                    }
                    patSpan.appendChild(numRowstext);
                    patSpan.appendChild(numRows);
                    patSpan.appendChild(patTable);
                    patSpan.setAttribute('onmousedown', 'neuralyteTracker.patMouseDown(event, "'+patTable.id+'");return false;');
                    var patExpander = document.getElementById('pat_' + patNo+'_expander');
                    var aRemovePattern = document.createElement('a');
                    aRemovePattern.href = '#';
                    aRemovePattern.innerHTML = '-';
                    aRemovePattern.setAttribute('onclick', 'neuralyteTracker.removePattern(event,'+patNo+'); return false;');

                    patExpander.appendChild(aRemovePattern);
                    //console.log(patExpander);
                },
                removePattern: function (evt, patNo) {
                    var patTable = document.getElementById('pat_' + patNo +'_table');
                    patTable.parentNode.removeChild(patTable);
                    var patExpander = document.getElementById('pat_' + patNo+'_expander');
                    var aRemovePattern = document.createElement('a');
                    aRemovePattern.href = '#';
                    aRemovePattern.innerHTML = '+';
                    aRemovePattern.setAttribute('onclick', 'neuralyteTracker.renderPattern(event,'+patNo+') return false;');
                    patExpander.appendChild(aRemovePattern);
                    console.log(patExpander);
                },
                noteChange: function (evt) {
                    var bits, pat, row, chan, dataidx, celldiv;

                    evt = evt || window.event;
                    console.log(evt);
                    //console.log(evt.currentTarget.childNodes[0].value);
                    bits = evt.currentTarget.id.split('_');
                    pat = bits[1];
                    row = bits[2];
                    chan = bits[3];
                    dataidx = parseInt((row * jsong.numChannels) + parseInt(chan));

                    console.log("before:");
                    console.log("row: " + row + " pat: " + pat + " chan: " + chan + " dataidx: " + dataidx);
                    console.log(jsong.patterns[pat].data[dataidx]);
                    // do a little dance to ensure we push a 5 element array 
                    // as a new pattern element.
                    var tmpNote = eval("new Array("+evt.currentTarget.childNodes[0].value+");");
                    while (tmpNote.length < 5) {
                        tmpNote.push(0);
                    }
                    jsong.patterns[pat].data[dataidx] = tmpNote.slice(0, 5);
                    console.log("after :");
                    console.log(jsong.patterns[pat].data[dataidx]);
                    neuralyteTracker.putPattern(pat, jsong.patterns[pat]);
                    
                    // this is the pretty way to render the cell elements:
                    //celldiv = document.getElementById(evt.currentTarget.id),
                    //if (evt.target.className == "note") {
                    //    jsong.patterns[pat].data[dataidx][0] = evt.target.value.replace(".","");
                    //}
                    //if (evt.target.className == "inst") {
                    //    jsong.patterns[pat].data[dataidx][1] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //if (evt.target.className == "vol") {
                    //    jsong.patterns[pat].data[dataidx][2] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //if (evt.target.className == "type") {
                    //    jsong.patterns[pat].data[dataidx][3] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //if (evt.target.className == "effval") {
                    //    jsong.patterns[pat].data[dataidx][4] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //neuralyteTracker.putPattern(pat, jsong.patterns[pat]);
                },
                putPattern: function (patNo, patDat) {
                    startWorking();
                    var putPatURL = apiRoot+"/" + apiName + "/pattern/" + patNo;
                    xmlhttp.open('POST', putPatURL, false); 
                    xmlhttp.send(JSON.stringify(patDat));
                    if(xmlhttp.status == 200)
                        console.log(putPatURL);      
                    //jsongglobals = eval("("+xmlhttp.responseText+")");
                    console.log("pattern updated");
                    stopWorking();
                },
                putSample: function (instNo, sampNo, sampDat) {
                    startWorking();
                    console.log(sampDat);
                    var putSampURL = apiRoot+"/" + apiName + "/instrument/" + instNo + "/sample/" + sampNo;
                    xmlhttp.open('POST', putSampURL, false); 
                    xmlhttp.send(JSON.stringify(sampDat));
                    if(xmlhttp.status == 200)
                        console.log(putSampURL);      
                    //jsongglobals = eval("("+xmlhttp.responseText+")");
                    console.log("sample updated");
                    stopWorking();
                },
                displayDebug: function () {
                    var debugDiv = document.getElementById('debug');
                    if(document.getElementById('showDebug').checked) {
                        debugDiv.style.display = 'inline';
                    }
                    else {
                        debugDiv.style.display = 'none';
                    }
                },
                patMouseDown: function (evt, patTableId) {
                    console.log(evt);
                    var mxy = getCursorPosition(evt);
                    //var pat = document.getElementById('patterns');
                    var pat = document.getElementById(patTableId);
                    console.log(pat);
                    var box = document.getElementById('pat_sel_box');
                    box.orig_x = mxy[0];
                    box.orig_y = mxy[1];
                    box.style.left = mxy[0]+"px";
                    box.style.top = mxy[1]+"px";
                    box.style.display = "block";

                    //pat.onmousemove = patMouseMove;
                    pat.setAttribute('onmousemove', "neuralyteTracker.patMouseMove(event, '"+patTableId+"');return false;");
                    document.onmouseup = neuralyteTracker.patMouseUp;
                    //document.setAttribute('onmouseup', "neuralyteTracker.patMouseUp(event, '"+patTableId+"');return false;");
                },
                patMouseMove: function (e, patTableId) {
                    //console.log('mouse moove: ' + patTableId);
                    var mxy = getCursorPosition(e);
                    var box = document.getElementById("pat_sel_box");
                    box.style.width = (mxy[0]-box.orig_x)+"px";
                    box.style.height = (mxy[1]-box.orig_y)+"px";

                    /*
                    patTable = null;
                    try {
                        //patTable = e.target.offsetParent.offsetParent;
                        patTable = e.currentTarget;
                    }
                    catch(ex) {
                        console.log('outside pattern editor. ignoring');
                        console.log(e);
                    }
                    if (patTable != null) {
                        var mxy = getCursorPosition(e);
                        patTable.style.width = (mxy[0]-patTable.orig_x)+"px";
                        patTable.style.height = (mxy[1]-patTable.orig_y)+"px";
                    }
                    else {
                        console.log(e);
                        console.log('no pattable!');
                    }*/
                },
                patMouseUp: function (e) {
                    console.log('mouse up: ' + e);
                    var box = document.getElementById("pat_sel_box");
                    console.log(box);
                    box.style.display = "none";
                    box.style.width = "0";
                    box.style.height = "0";

                    console.log(e);
                    document.onmousemove = function(){};
                    document.onmouseup = function(){};

                    /*
                    patTableId = null;
                    try {
                        patTableId = e.target.offsetParent.offsetParent.id;
                        var box = document.getElementById(patTableId);
                        box.style.display = "none";
                        box.style.width = "0";
                        box.style.height = "0";
                    }
                    catch(ex) {
                        console.log('outside pattern editor. ignoring');
                    }
                    document.onmousemove = function(){};
                    document.onmouseup = function(){
                        alert('mouse up');
                    };*/
                }
            }
            function loadWavFile (evt) {
                if (document.getElementById(evt.target.id).files.length === 0) { return; }
                var oFile = document.getElementById(evt.target.id).files[0];
                var objectURL = window.URL.createObjectURL(oFile);
                var reader = new FileReader();
                reader.file = oFile;
                reader.onload = function (e) {
                    var file = this.file;
                    var decoder = new WAVDecoder();
                    var decoded = decoder.decode(e.target.result);
                    var scale = Math.pow(2, decoded.bitDepth)/2.0; // divide by to because we are using signed ints.
                    var jsongInst = new Array(decoded.length);
                    for (var i = 0; i < decoded.length; i += 1) {
                        jsongInst[i] = Math.round(decoded.channels[0][i]*scale);
                    }
                    console.log(file);
                    setNewSample(jsongInst, evt.target.id, file.name, 8363, 0);
                }
                reader.readAsBinaryString(oFile);
            }

            function getCursorPosition(e) {
                e = e || window.event;
                if (e)
                {
                    if (e.pageX || e.pageX == 0) return [e.pageX,e.pageY];
                    var dE = document.documentElement || {};
                    var dB = document.body || {};
                    if ((e.clientX || e.clientX == 0) && ((dB.scrollLeft || dB.scrollLeft == 0) || (dE.clientLeft || dE.clientLeft == 0))) return [e.clientX + (dE.scrollLeft || dB.scrollLeft || 0) - (dE.clientLeft || 0),e.clientY + (dE.scrollTop || dB.scrollTop || 0) - (dE.clientTop || 0)];
                }
                return null;
            }


            function setNewSample(dat, idstr, name, c2Rate, relNote) {
                var n = idstr.split('_');
                var sampJson = {'name': name,
                    'c2Rate': c2Rate,
                    'fineTune': 0,
                    'loopLength': 0,
                    'loopStart': dat.length - 1,
                    'panning': 128,
                    'relNote': relNote,
                    'sampleData': dat,
                    'volume': 64};
                jsong.instruments[n[1]].samples[n[2]] = sampJson;
                var sampCanvas = document.getElementById(n[0] +"_"+ n[1] +"_"+ n[2] +'_canvas');
                //console.log(jsong.instruments[n[1]].samples[n[2]][0].sampleData);
                console.log('new sample data is set. inst ' + n[1] + ' sample ' + n[2]);
                drawSample(sampCanvas.getContext('2d'), dat);
                neuralyteTracker.putSample(n[1], n[2], sampJson);
            }
            function newSample (dat, name) {
                if (dat == null)
                    return {'name': name,
                        'c2Rate': 8363,
                        'fineTune': 0,
                        'loopLength': 0,
                        'panning': 128,
                        'relNote': 0,
                        'volume': 64};
                return {'name': name,
                    'c2Rate': 8363,
                    'fineTune': 0,
                    'loopLength': 0,
                    'loopStart': dat.length - 1,
                    'panning': 128,
                    'relNote': 0,
                    'sampleData': dat,
                    'volume': 64};
            }
            function drawSample(ctx, sampData) {
                var i = 0,
                    width = ctx.canvas.width,
                    height = ctx.canvas.height,
                    points = sampData.length,
                    pointspx = width/points;

                ctx.clearRect(0, 0, width, height);
                ctx.beginPath();
                ctx.strokeStyle = '"rgb(255,165,0)";';
                ctx.moveTo(0,0);
                ctx.moveTo(0,height/2+((height*sampData[0])/65534.0));
                for (var pt = 1; pt < points; pt += Math.ceil(points/1000)) {
                    ctx.lineTo(pt*(width/points), height/2+((height*sampData[pt])/65534.0));
                }
                ctx.stroke();
                ctx.closePath();

                console.log('drawn.');
            }

            function startWorking() {
                var image = document.createElement('img');
                image.src = "http://imageshack.us/scaled/landing/691/throbber.gif";
                document.getElementById('working').appendChild(image);
            }
            function stopWorking() {
                var node = document.getElementById('working');
                var targetpathspan = document.getElementById('targetpath');
                targetpathspan.innerHTML = targetpath;
                rmChildren(node);
            }
            function rmChildren(node) {
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
            }
            function updateUI(jsong) {
                for (var key in jsong) {
                    if (jsong.hasOwnProperty(key)) {
                        var node = document.getElementById(key);
                        if (node != null) {
                            node.value = jsong[key];
                        }
                    }
                }
                var patternView = document.getElementById('patternView');
                rmChildren(patternView);
                for (var i = 0; i < jsong.patterns.length; i+=1) {
                    patternView.appendChild(getPatSpan(jsong.patterns[i], "pat "+i));
                }

                var instrumentView = document.getElementById('instrumentView');
                rmChildren(instrumentView);
                var i;
                for (i = 1; i < jsong.instruments.length; i += 1) {
                    var inst = jsong.instruments[i];
                    instrumentView.appendChild(getInstSpan(inst, i, rightjustify(i,2)+" "+inst.name));
                }
            }
            function getPatSpan(pat, patName) {
                var i = pat.patNumber;
                var patSpan = document.createElement('span');
                patSpan.id = 'pat_'+i;

                var patText = document.createTextNode(patName);
                var patA = document.createElement('a');
                patA.href = '#';
                patA.innerHTML = '+';
                patA.id = 'pat_'+pat.patNumber+'_expander';
                patA.setAttribute('onclick', 'neuralyteTracker.renderPattern(event,'+i+'); return false;');
                var patB = document.createElement('a');
                patB.href = '#';
                patB.innerHTML = '>';
                patB.setAttribute('onclick', 'neuralyteTracker.loopPattern(event,'+i+'); return false;');
                patSpan.appendChild(patText);
                patSpan.appendChild(patA);
                patSpan.appendChild(patB);
                patSpan.appendChild(document.createTextNode('  '));
                //console.log('rendered pattern: ' + i);
                return patSpan;
            }
            function newPattern(channels, rows, patNum) {
                var pat = new Array(channels*rows), 
                    i = 0;
                while (i < (channels * rows)) {
                    pat[i] = [0,0,0,0,0];
                    i += 1;
                }
                return {'numRows': rows, 'patNumber': patNum, 'data': pat};
            }
            function getInstSpan(inst, instNo, instName) {
                var instSpan = document.createElement('div');
                instSpan.id = "inst_"+instNo;
                instSpan.className = 'instClass';
                var instA = document.createElement('a');
                instA.href = "#";
                instA.innerHTML = instName;
                instA.onclick = new Function("neuralyteTracker.renderInstrument("+instNo+"); return false;");
                instSpan.appendChild(instA);
                return instSpan;
            }
            function getRow(patno, pattern, rowNum, chanNum, numChannels) {
                var chans = null,
                res = "",
                count = 0,
                i = 0,
                row = null,
                rowidx,
                td = document.createElement('td'),
                note = document.createElement('input'),
                inst = document.createElement('input'),
                vol = document.createElement('input'),
                eff = document.createElement('input'),
                effval = document.createElement('input');

                rowidx = (rowNum * numChannels) + chanNum;
                row = pattern.data[rowidx];

                var rowinput = document.createElement('input');
                rowinput.value = row;
                rowinput.size = 10;
                //rowinput.onchange = new Function(console.log(rowinput));
                td.appendChild(rowinput)
                return td;

                note.type = 'type';
                note.size = 3;
                note.value = getNote(row);
                note.className = 'note';

                inst.type = 'type';
                inst.size = 2;
                inst.value = getInst(row);
                inst.className = 'inst';

                vol.type = 'type';
                vol.size = 3;
                vol.value = getVol(row);
                vol.className = 'vol';

                eff.type = 'type';
                eff.size = 1;
                eff.value = getEff(row);
                eff.className = 'eff';

                effval.type = 'type';
                effval.size = 2;
                effval.value = getEffVal(row);
                effval.className = 'effval';

                td.appendChild(note);
                td.appendChild(inst);
                td.appendChild(vol);
                td.appendChild(eff);
                td.appendChild(effval);
                return td;
            }
            function getNote(row) {
                var int = row[0],
                    ret = "";
                if (int == 97) {
                    return "---";
                }
                ret += NOTES[int % 12];
                ret += Math.floor(int / 12);
                return ret;
            }
            function getInst(row) {
                return rightjustify(row[1].toString(16), 2);
            }
            function getVol(row) {
                return rightjustify(row[2], 3);
            }
            function rightjustify(value, places) {
                var ret = "";
                ret = value + "";
                if (ret.length < 2) {
                    ret = "." + ret;
                }
                if (ret.length < 3) {
                    ret = "." + ret;
                }
                return ret.substring(3 - places);
            }
            function getEff(row) {
                return row[3];
            }
            function getEffVal(row) {
                var int = row[4],
                    ret = "";
                ret = int + "";
                if (ret.length < 2) {
                    ret = "0" + ret;
                }
                return ret;
            }
        }());

</script>
    <body onLoad="init();"> 
        <div id='title'>NeuralyteTracker v0.4.2 <span id='working'></span>tune target: <span id='targetpath'></span><span style='float:right;'>Show debug<input  id='showDebug' name=cb1 value=test type=checkbox onchange='neuralyteTracker.displayDebug()' checked></span></div>
        <span id='trackerUI'>
        <div id='tuneBrowser'><span class='spanlabel'>file</span>
            load {xm,s3m,mod,jsong} from: <input id='loadURL' type="text" size="25" value="http://modarchive.org/data/downloads.php?moduleid=122252#caustic_platform.mod"/>
            <a href='#' class='but' onClick='neuralyteTracker.load("loadURL");'>load</a> or 
            <a href='#' class='but' onClick='neuralyteTracker.new();'>new</a> <br/>
            <input id='docStore' type="text" size="25" value=""/>
            <a href='#' id='saveURL' type='text' class='but' onClick='neuralyteTracker.save();'>save</a>
            <a href='#' id='savecopyURL' type='text' class='but' onClick='neuralyteTracker.savecopy("saveURL");'>save a copy</a>
        </div>
        <div id='rendercontrols'><span class='spanlabel'>controls</span>
            <a href='#' class='but' id='playbutton' onClick='neuralyteTracker.play();'>play</a><br/>
            <a href='#' class='but' id='stopbutton' onClick='neuralyteTracker.pause();'>pause</a><br/>
            <a href='#' class='but' id='stopbutton' onClick='neuralyteTracker.restart();'>restart</a><br/>
        </div>
        <div id='tuneMetadata'><span class='spanlabel'>globals</span>
            tune name: <input id='songName' type='text' size='25' onblur="neuralyteTracker.updateJsong(event)"/></br>
            gain: <input id='gain' type='text' size='5' onblur="neuralyteTracker.updateJsong(event)"/></br>
            defaultSpeed: <input id='defaultSpeed' type='text' size='5' onblur="neuralyteTracker.updateJsong(event)"/></br>
            defaultTempo: <input id='defaultTempo' type='text' size='5' onblur="neuralyteTracker.updateJsong(event)"/>
            sequence: <input id='sequence' type='text' size='15' onblur="neuralyteTracker.updateJsong(event)"/>
        </div>
        <div id='instruments'><span class='spanlabel'>instruments</span>
            <span><a href='#' onClick='neuralyteTracker.addNewInstrument(); return false;'>add new</a></span>
            <div id='instrumentView'></div>
            <div id='sampleView'></div>
        </div>
        <div id='debug'><span class='spanlabel'>debug</span>
            <a href='#' id='getJsong' type='text' class='but' onClick='neuralyteTracker.getJsong("");'>getJsong</a>
            <a href='#' id='putJsong' type='text' class='but' onClick='neuralyteTracker.putJsong("");'>pushJsong</a>
            <a href='#' type='text' class='but' onClick='neuralyteTracker.saveJsong("");'>saveJsong</a>
            <a href='#' type='text' class='but' onClick='neuralyteTracker.updateUI("");'>updateUI</a>
            <a href='#' type='text' class='but' onClick='neuralyteTracker.getStatus("");'>get status</a>
            </div>
            <div id='pat_sel_box'></div>
        <div id='patterns'><span class='spanlabel'>patterns</span>
            <span><a href='#' onClick='neuralyteTracker.addNewPattern(); return false;'>add new</a></span>
            <div id='patternView'></div>
        </div>

        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <span>

        <span id='documentation'>
        <h2>Doc</h2>
        Neuralyte Tracker is a RESTful <a href='http://en.wikipedia.org/wiki/Music_tracker'>music tracker</a>. There is a UI written in HTML5+javascript with a rendering engine, written in Java, based on IBXM. Neuralyte Tracker can be run in 'Cloud Utility' mode, where the rendering engine is in the cloud. For what that's worth.

        <h3>Persisting your jsong</h3>
        Provided you've included a doc store url, Jsongs can be persisted using the <b>save</b> and <b>save copy</b> buttons. This app has currently be tested with couchdb from <a href='http://iriscouch.com'>iriscouch.com</a> - who provide free storage, depending on your usage. In theory, you can also save the jsong from the browser locally, and then load it with a local 'file://' url.

        <h3>Supported Formats</h3>
        A tune is either a mod, xm, s3m, jsong, or a zip containing a mod, xm, s3m. Neuralyte Tracker reads and writes it's native <b>jsong</b> format.

        <h3>Patterns and effect</h3>
        Pattern cells are in order, left to right: note, inst, vol, eff, effval. Supported effects are listed way below.

        <h3>Neuralyte Tracker API</h3>

        Currently supported endpoints - all assume <b>http://HOST/drainpipe/&lt;ENCODED_URI_OF_TUNE&gt;/</b>. 

        <table>
            <tr><th>name</th><th>GET</th><th>POST</th><th>CREATE</th><th>DELETE</th><th>notes</th></tr>
            <tr><td>play</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>save</td><td>X</td><td></td><td></td><td></td><td>save jsong to jsongtarget, provided it's writable, like iriscouch.com</td></tr>
            <tr><td>savecopy </td><td>X</td><td></td><td></td><td></td><td>saves jsong to a specified doc-store (iriscouch.com)</td></tr>
            <tr><td>restart</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>stop</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>sequence</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>patterns</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>instruments</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>samples</td><td>X</td><td>X</td><td></td><td></td><td>Samples included in instruments.</td></tr>
            <tr><td>jsong</td><td>X</td><td>X</td><td></td><td></td><td>Pushes the whole client side jsong DOM entry to the server.</td></tr>

        </table>

<script>
</script>

        <h3>END DOC</h3>

        <h3>FAQ</h3>

        <h4>Hells teeth! this UI doesn't even have $BASIC_FEATURE. Even I could program that!</h4>

        A: Sweet! Let me know what I should do to make submitting a patch easy for you!
        
        <h4>Q: Where can I get help?</h4>
        A: You can find me, you can email me. If I get enough emails I'll set up a mailing list. Or maybe <a href='http://www.pouet.net/topic.php?which=9007'>thread 9007 on pouet.net</a> will suffice.


        <h4>Q: What effects are supported?</h4>

        The effects are based on XM supported effects. The integer equivalents are:
<pre>

nt, int equivalent      XM effect
  0                    0xy: Arpeggio                          
  1                    1xy: Portamento Up                     
  2                    2xy: Portamento Down                   
  3                    3xy: Tone-Portamento                   
  4                    4xy: Vibrato                           
  5                    5xy: Tone-Portamento + Volume Slide    
  6                    6xy: Vibrato + Volume Slide            
  7                    7xy: Tremolo                           
  8                    8xy: Set Panning                       
  9                    9xy: Set Sample Offset                 
 10                    Axy: Volume Slide                      
  ?                    Bxy: Position Jump                     
 12                    Cxy: Set Volume                        
  ?                    Dxy: Pattern Break                     
  ?                    Exy: Extended MOD Commands             
  ?                    Fxy: Set Speed/Tempo                   
 16                    Gxy: Set Global Volume
 17                    Hxy: Global Volume Slide
 20                    Kxy: Key Off
 21                    Lxy: Set Envelope Position
 25                    Pxy: Panning Slide
 27                    Rxy: Retrig
 29                    Txy: Tremor
  ?                    Xxy: Extended XM effects
  ?                    Zxy: Macros

? = I haven't figured it out, or it isn't supported, or both.
</pre>


        <h2>Greetings</h2>
        UK Scene, Pouet.net massive.

        Don't forget to check the <a href='http://pouet.net/groups.php?which=10807'>Neuralyte back catalogue on Pouet.net</a><br/>

        <h3>Licenses</h3>
        The tracker and modifications to IBXM. <a href='http://www.gnu.org/licenses/agpl-3.0.html'>AGPLv3</a><br/>
        <a href='http://code.google.com/p/micromod/'>IBXM</a> <a href='http://opensource.org/licenses/BSD-3-Clause'>New BSD License.<br/>
    <a href="https://raw.github.com/oampo/audiofile.js/master/audiofile.js">Audiofile.js</a> <a href='https://github.com/oampo/audiofile.js/blob/master/LICENSE'>Public Domain Like</a>
        

    </span>



    </body>
</html>
