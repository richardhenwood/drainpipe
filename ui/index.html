<!-- 
    Project Drainpipe: A RESTful sound tracker
    Copyright (C) 2012,2013  Richard Henwood rjhenwod@yahoo.co.uk

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
    <meta charset="UTF-8">
    <!--script type="text/javascript" src="https://raw.github.com/jussi-kalliokoski/pcmdata.js/master/js/pcmdata.js"></script-->
    <!--script type='text/javascript' src='https://raw.github.com/oampo/audiofile.js/master/audiofile.js'></script-->
    <script language='javascript' src="https://raw.github.com/oampo/audiofile.js/master/audiofile.js"></script>

    <style type="text/css">
        #patterns table {
            border: 10px;
            width: 100%;
        }
        #rendercontrols {
            background-color: #88ff00;
            float: left;
            width: 100px;
            padding: 10px;
        }
        #modbrowser {
            width: 200px;
            float: left;
            background-color: green;
            padding: 10px;
        }
        #patternView {
            width: 100%;
            float: left;
            background-color: #ddddff;
            display: block;
        }
        #instruments {
            width: 600px;
            float: left;
            background-color: #ffdddd;
            height: 200px;
        }
        #documentation {
            width: 800px;
            display: block;
        }       

        #instrumentView {
            width: 200px;
            float: left;
            overflow: auto;
            height: 200px;
        }
        #sampleView {
            width: 400px;
            float: left;
            overflow: auto;
            height: 200px;
            background-color: #ffcccc;
        }
        #modMetadata {
            width: 250px;
            float: left;
        }
        .note {
            color: purple;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .inst {
            color: green;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .vol {
            color: yellow;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .eff {
            color: black;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .effval {
            color: red;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .but {
            background-color: #ffddff;
            border: 0px;
            padding: 0px;
        }
        .patternSelector {
            background-color: #ddffdd;
            border: 5px;
            padding: 5px;
        }
        #trackerUI {
            display: none;
        }
  </style>

    <script type="text/javascript">
        //var nt = neuralyteTracker();
        function init() {
            console.log("loading browser");
            //nt = NeuralyteTracker();

            //browser.registerTracker(nt);
        }

        function load(evt) {
            nt.handleFileSelect(evt);
        }

        //this.ModBrowser = (function() {

        //        function init() {
        //            console.log("Starting browser");
        //        }
        //        function registerTracker(tracker) {

        //        }

        //        return init;
        //}());


        var neuralyteTracker = (function() {
            mod = null;
            //var mod = null; //uncomment this to make it private
            var readURL = null;
            var xmlhttp = new XMLHttpRequest();
            var apiName = "";
            var apiRoot = document.location.href.split("#")[0];
            var writeRoot = document.location.href.split("#")[0];
            var readRoot = document.location.href.split("#")[0];
            var NOTES = ["..", "C-", "C#", "D-", "D#", "E-", "F-","F#", "G-", "G#", "A-", "A#", "B-"];

            return {
                init: function() {
                    if (window.File && window.FileReader && window.FileList && window.Blob) {
                        // Great success! All the File APIs are supported.
                        console.log('The File APIs are fully supported in this browser.');
                        document.getElementById('files').addEventListener('change', handleFileSelect, false);
                    } else {
                        alert('The File APIs are not fully supported in this browser.');
                    }
                },
                new: function() {
                    startWorking();
                    newRoot = apiRoot+"/new/new";
                    xmlhttp.open('GET', newRoot, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        console.log("new jsong created");
                        console.log(xmlhttp.responseText);
                    }
                    else {
                        console.log("can not create new jsong");
                    }
                    console.log("load complete");
                    stopWorking();
                },
                load: function(id) {
                    startWorking();
                    readURL = document.getElementById(id).value;
                    console.log("loading: " + readURL);  
                    apiName = encodeURIComponent(readURL);
                    readRoot = apiRoot+"/"+apiName+"";
                    xmlhttp.open('GET', readRoot, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        mod = eval("("+xmlhttp.responseText+")");
                    }
                    else {
                        console.log("can't load");
                    }
                    console.log("load complete");
                    stopWorking();
                },
                save: function(storeURL) {
                    startWorking();
                    storeURL = apiRoot+"/" + apiName + "/save";
                    console.log("saving: " + storeURL);  
                    xmlhttp.open('GET', storeURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log(storeURL);      
                    modglobals = eval("("+xmlhttp.responseText+")");
                    stopWorking();
                },
                play: function() {
                    playURL = apiRoot+"/" + apiName + "/play";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("playing: " + playURL);  
                },
                pause: function() {
                    playURL = apiRoot+"/" + apiName + "/stop";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("stopped: " + playURL);  
                },
                restart: function() {
                    playURL = apiRoot+"/" + apiName + "/restart";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("stopped: " + playURL);  
                },
                loopPattern: function(evt, patNo) {
                    loopUri = apiRoot+'/' + apiName + "/pattern/" + patNo + "/play";
                    xmlhttp.open('GET', loopUri, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log(loopUri);      
                },
                updateUI: function() {
                    startWorking();
                    updateUI(mod);
                    stopWorking();
                },
                updateMod: function(evt) {
                   if (evt.keyCode == 13) {
                       mod[evt.target.id] = document.getElementById(evt.target.id).value;
                       putMod();
                   }
                },
                putMod: function() {
                    startWorking();
                    putModURL = apiRoot+"/" + apiName + "/save";
                    xmlhttp.open('POST', putModURL, false); 
                    xmlhttp.send(JSON.stringify(mod));
                    if(xmlhttp.status == 200)
                        console.log(putModURL);      
                    modglobals = eval("("+xmlhttp.responseText+")");
                    console.log(modglobals);
                    stopWorking();
                },
                renderInstrument: function(instNo) {
                    var inst = mod.instruments[instNo];
                    console.log(inst);
                    var instSpan = document.getElementById('inst_'+instNo);
                    //name = document.createElement('input');
                    //name.value = inst.name;
                    //name.onchange = function() {inst.name = name.value;};
                    //name = document.createElement('href');
                    //instSpan.appendChild(name);
                    var sampView = document.getElementById('sampleView');
                    for (var i = 0; i < inst.numSamples; i += 1) {
                        this.renderSample(instNo, i);
                        //var sampleA = document.createElement('a');
                        //sampleA.href = '#';
                        //sampleA.innerHTML = "samp_"+i;
                        //sampleA.setAttribute('onclick', 'neuralyteTracker.renderSample(event,'+instNo+','+i+')');
                        //var sampSpan = document.createElement('span');
                        //sampSpan.id = 'samp_'+instNo+'_'+i;
                        //sampView.appendChild(sampSpan);
                        //sampView.appendChild(sampleA);
                    }

                },
                renderSample: function(instNo, sampNo) {
                    samp = mod.instruments[instNo].samples[sampNo];
                    //sampSpan = document.getElementById('samp_' + instNo + '_'+sampNo);
                    sampView = document.getElementById('sampleView');
                    while (sampView.hasChildNodes()) {
                        sampView.removeChild(sampView.lastChild);
                    }
                    var sampSpan = document.createElement('span');
                    sampSpan.id = 'samp_'+instNo+'_'+sampNo;
                    sampView.appendChild(sampSpan);

                    if (!('sampleData' in samp)) {
                        console.log('no sample data, initializing.');
                        var initSize = 1000;
                        samp.sampleData = new Array(initSize);
                        while (--initSize >= 0) {
                            samp.sampleData[initSize] = 0;
                        }

                    }
                    sampCanvas = document.createElement('canvas');
                    sampCanvas.setAttribute('height', 100);
                    sampCanvas.setAttribute('width', 300);
                    sampCanvas.id = 'samp_' + instNo + '_'+sampNo + '_canvas';
                    sampSpan.appendChild(sampCanvas);
                    drawSample(sampCanvas.getContext('2d'), samp.sampleData);

                    var sampUpload = document.createElement('input');
                    sampUpload.id = 'samp_'+instNo+'_'+sampNo+'_upload';
                    sampUpload.type = 'file';
                    sampUpload.onchange = loadWavFile;
                    sampSpan.appendChild(sampUpload);

                    console.log('sample data is ready for drawing.');
                    
                    //console.log(samp.sampleData);
                },
                renderPattern: function(evt, patNo) {
                    pat = mod.patterns[patNo];
                    // there is a span already in the pattern
                    // dom object because one is created 
                    // in the 'private' method 'updateUI'.
                    // This design is terriable and should be
                    // fixed.
                    patSpan = document.getElementById('pat_' + patNo);
                    console.log("rendering pattern: " + patNo);
                    console.log(pat);
                    var patTable = document.createElement('table');
                    patTable.id = "pat_"+patNo+"_table";
                    for (row = 0; row < pat.numRows; row += 1) {
                        tr = document.createElement('tr');
                        for (chan = 0; chan < mod.numChannels; chan += 1) { 
                            td = getRow(patNo, pat, row, chan, mod.numChannels);
                            td.id = "cell_"+ patNo+ "_" + row + "_" + chan;
                            td.onchange = this.noteChange;
                            tr.appendChild(td);
                        }
                        patTable.appendChild(tr);
                    }
                    patSpan.appendChild(patTable);
                    patExpander = document.getElementById('pat_' + patNo+'_expander');
                    patExpander.innerHTML = '-';
                    patExpander.setAttribute('onclick', 'neuralyteTracker.removePattern(event,'+patNo+')');
                    console.log(patExpander);
                },
                removePattern: function (evt, patNo) {
                    patTable = document.getElementById('pat_' + patNo +'_table');
                    patTable.parentNode.removeChild(patTable);
                    patExpander = document.getElementById('pat_' + patNo+'_expander');
                    patExpander.innerHTML = '+';
                    patExpander.setAttribute('onclick', 'neuralyteTracker.renderPattern(event,'+patNo+')');
                },
                noteChange: function (evt) {
                    var bits, pat, row, chan, dataidx, celldiv;

                    evt = evt || window.event;
                    log(evt);
                    bits = evt.currentTarget.id.split('_');
                    pat = bits[1];
                    row = bits[2];
                    chan = bits[3];
                    //celldiv = document.getElementById(evt.currentTarget.id),
                    dataidx = parseInt((row * patterns[pat].numRows) + chan);

                    if (evt.target.className == "note") {
                        patterns[pat].data[dataidx][0] = evt.target.value.replace(".","");
                    }
                    if (evt.target.className == "inst") {
                        patterns[pat].data[dataidx][1] = parseInt(evt.target.value.replace(".",""));
                    }
                    if (evt.target.className == "vol") {
                        patterns[pat].data[dataidx][2] = parseInt(evt.target.value.replace(".",""));
                    }
                    if (evt.target.className == "type") {
                        patterns[pat].data[dataidx][3] = parseInt(evt.target.value.replace(".",""));
                    }
                    if (evt.target.className == "effval") {
                        patterns[pat].data[dataidx][4] = parseInt(evt.target.value.replace(".",""));
                    }
                    put_pattern(pat, patterns[pat]);
                    
                    //log(pat + " " + row + " " + chan);
                    //log(window.event);
                    //log(val);
                }

            }
            function loadWavFile (evt) {
                if (document.getElementById(evt.target.id).files.length === 0) { return; }
                var oFile = document.getElementById(evt.target.id).files[0];
                var objectURL = window.URL.createObjectURL(oFile);
                var reader = new FileReader();
                reader.file = oFile;
                reader.onload = function (e) {
                    var file = this.file;
                    var decoder = new WAVDecoder();
                    var decoded = decoder.decode(e.target.result);
                    var scale = Math.pow(2, decoded.bitDepth)/2.0; // divide by to because we are using signed ints.
                    var modInst = new Array(decoded.length);
                    for (var i = 0; i < decoded.length; i += 1) {
                        modInst[i] = Math.round(decoded.channels[0][i]*scale);
                    }
                    setSample(modInst, evt.target.id);
                }
                reader.readAsBinaryString(oFile);
            }

            function setSample(dat, idstr) {
                var n = idstr.split('_');
                mod.instruments[n[1]].samples[n[2]][0] = {name: 'test name',
                    sampleData: dat,
                    volume: 64};
                var sampCanvas = document.getElementById(n[0] +"_"+ n[1] +"_"+ n[2] +'_canvas');
                console.log(mod.instruments[n[1]].samples[n[2]][0].sampleData);
                drawSample(sampCanvas.getContext('2d'), dat);
            }

            function drawSample(ctx, sampData) {
                var i = 0,
                    width = ctx.canvas.width,
                    height = ctx.canvas.height,
                    points = sampData.length,
                    pointspx = width/points;

                ctx.clearRect(0, 0, width, height);
                ctx.beginPath();
                ctx.strokeStyle = '"rgb(255,165,0)";';
                ctx.moveTo(0,0);
                ctx.moveTo(0,height/2+((height*sampData[0])/65534.0));
                for (pt = 1; pt < points; pt += Math.ceil(points/1000)) {
                    ctx.lineTo(pt*(width/points), height/2+((height*sampData[pt])/65534.0));
                }
                ctx.stroke();
                ctx.closePath();

                console.log('drawn.');
            }

            function startWorking() {
                var image = document.createElement('img');
                image.src = "http://imageshack.us/scaled/landing/691/throbber.gif";
                document.getElementById('working').appendChild(image);
            }
            function stopWorking() {
                var node = document.getElementById('working');
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
            }
            function updateUI(mod) {
                for (var key in mod) {
                    if (mod.hasOwnProperty(key)) {
                        var node = document.getElementById(key);
                        if (node != null) {
                            node.value = mod[key];
                        }
                    }
                }
                var patternView = document.getElementById('patternView');
                for (var i = 0; i < mod.patterns.length; i+=1) {
                    var pat = mod.patterns[i];
                    var patSpan = document.createElement('span');
                    patSpan.id = 'pat_'+pat.patNumber;
                    var patText = document.createTextNode('pat ' + i);
                    var patA = document.createElement('a');
                    patA.href = '#';
                    patA.innerHTML = '+';
                    patA.id = 'pat_'+pat.patNumber+'_expander';
                    patA.setAttribute('onclick', 'neuralyteTracker.renderPattern(event,'+i+')');
                    var patB = document.createElement('a');
                    patB.href = '#';
                    patB.innerHTML = '>';
                    patB.setAttribute('onclick', 'neuralyteTracker.loopPattern(event,'+i+')');
                    patSpan.appendChild(patText);
                    patSpan.appendChild(patA);
                    patSpan.appendChild(patB);
                    patSpan.appendChild(document.createTextNode('  '));
                    patternView.appendChild(patSpan);
                }
                var instrumentView = document.getElementById('instrumentView');
                for (var i = 0; i < mod.instruments.length; i += 1) {
                    instrumentView.appendChild(getInstSpan(i));
                }
            }
            function getInstSpan(i) {
                var inst = mod.instruments[i];
                var instSpan = document.createElement('div');
                instSpan.id = "inst_"+i;
                instSpan.class = 'instClass';
                var instA = document.createElement('a');
                instA.href = "#";
                instA.innerHTML = rightjustify(i,2)+" "+inst.name;
                instA.onclick = new Function("neuralyteTracker.renderInstrument("+i+")");
                //instA.setAttribute('onclick', 'neuralyteTracker.renderInstrument(event,'+i+')');
                instSpan.appendChild(instA);
                return instSpan;
            }
            function getRow(patno, pattern, rowNum, chanNum, numChannels) {
                var chans = null,
                res = "",
                count = 0,
                i = 0,
                row = null,
                td = document.createElement('td'),
                note = document.createElement('input'),
                inst = document.createElement('input'),
                vol = document.createElement('input'),
                eff = document.createElement('input'),
                effval = document.createElement('input');

                rowidx = (rowNum * numChannels) + chanNum;
                row = pattern.data[rowidx];

                note.type = 'type';
                note.size = 3;
                note.value = getNote(row);
                note.className = 'note';

                inst.type = 'type';
                inst.size = 2;
                inst.value = getInst(row);
                inst.className = 'inst';

                vol.type = 'type';
                vol.size = 3;
                vol.value = getVol(row);
                vol.className = 'vol';

                eff.type = 'type';
                eff.size = 1;
                eff.value = getEff(row);
                eff.className = 'eff';

                effval.type = 'type';
                effval.size = 2;
                effval.value = getEffVal(row);
                effval.className = 'effval';

                td.appendChild(note);
                td.appendChild(inst);
                td.appendChild(vol);
                td.appendChild(eff);
                td.appendChild(effval);
                return td;
            }
            function getNote(row) {
                var int = row[0],
                    ret = "";
                if (int == 97) {
                    return "---";
                }
                ret += NOTES[int % 12];
                ret += Math.floor(int / 12);
                return ret;
            }
            function getInst(row) {
                return rightjustify(row[1].toString(16), 2);
            }
            function getVol(row) {
                return rightjustify(row[2], 3);
            }
            function rightjustify(value, places) {
                var ret = "";
                ret = value + "";
                if (ret.length < 2) {
                    ret = "." + ret;
                }
                if (ret.length < 3) {
                    ret = "." + ret;
                }
                return ret.substring(3 - places);
            }
            function getEff(row) {
                return row[3];
            }
            function getEffVal(row) {
                var int = row[4],
                    ret = "";
                ret = int + "";
                if (ret.length < 2) {
                    ret = "0" + ret;
                }
                return ret;
            }
        }());

//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
//////////////////////////////////old code below///////////////////////////////////////
        //neuralyteTracker.load("http://modarchive.org/data/downloads.php?moduleid=122252#caustic_platform.mod");

        this.NeuralyteTracker = (function() {
        var playUri;
        var restartUri;
        var stopUri;
        var saveUri;
   //     var globalVolUri;
        var sequenceUri;
        var patternUri;
        var loopPatternUri;
        var patternsUri;
        var instrumentsUri;
        var jsongUri;

        var xmlhttp;
        //var globalVol = null;
        var modglobals = null;
        var sequence = null;
        var patterns = null;
        var instruments = null;
        var loopPatternNo = null;

        function init() {
            // init for ajax requests.
            console.log("init tracker");
            xmlhttp = new XMLHttpRequest();
            initAPI();
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
                console.log('The File APIs are fully supported in this browser.');
                document.getElementById('files').addEventListener('change', handleFileSelect, false);
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }
        }

        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object

            // files is a FileList of File objects. List some properties.
            var output = [];
            for (var i = 0, f; f = files[i]; i++) {
                output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                        f.size, ' bytes, last modified: ',
                        f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                        '</li>');
            }
            document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
        }


        function initAPI() {
            var tuneUri = document.getElementById('tuneUri').value;
            //var saveUri = document.getElementById('saveUri').value;
            var codedUri = encodeURIComponent(tuneUri);
            loadUri = document.location.href + "/" + codedUri + "";
            jsongUri = document.location.href + "/" + codedUri + "/jsong";

            saveUri = document.location.href + "/" + codedUri + "/save";
            playUri = document.location.href + "/" + codedUri + "/play";
            // loopPatternUri is a dogs dinner:
            loopPatternUri = document.location.href + "/" + codedUri + "/pattern/";
            restartUri = document.location.href + "/" + codedUri + "/restart";
            stopUri = document.location.href + "/" + codedUri + "/stop";
            //globalVolUri = document.location.href + "/" + codedUri + "/global_volume";
            sequenceUri = document.location.href + "/" + codedUri + "/sequence";
            patternUri = document.location.href + "/" + codedUri + "/pattern";
            patternsUri = document.location.href + "/" + codedUri + "/patterns";
            instrumentsUri = document.location.href + "/" + codedUri + "/instruments";
        }

        function get_jsong() {
            xmlhttp.open('GET', jsongUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200)
                log(jsongUri);      
        }


        function load() {
            initAPI();
            xmlhttp.open('GET', loadUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200)
                log(loadUri);      
                modglobals = eval("("+xmlhttp.responseText+")");
        }

        function _save() {
            xmlhttp.open('GET', saveUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200)
                log(saveUri);      
                modglobals = eval("("+xmlhttp.responseText+")");
        }

        function play() {
            xmlhttp.open('GET', playUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200)
                log(playUri);      
        }

        function restart() {
            xmlhttp.open('GET', restartUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200)
                log(restartUri);      
        }

        function loopPatternPlay(patNo) {
            loopUri = loopPatternUri + patNo + "/play";
            xmlhttp.open('GET', loopUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200)
                log(loopUri);      
        }

        function stop() {
            xmlhttp.open('GET', stopUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200)
                log(stopUri);      
        }

        function get_sequence() {
            if (sequence != null)
                return;
            xmlhttp.open('GET', sequenceUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200) {
                sequence = eval("("+xmlhttp.responseText+")");
                log(xmlhttp.responseText);      
            }
            update_sequence_div(sequence);
        }
        function put_sequence(arrayStr) {
            xmlhttp.open('POST', sequenceUri, false); 
            send = arrayStr; //"[" + window.sequence.join(",") + "]";
            xmlhttp.send(send);
            alert("sending"+arrayStr);
            if(xmlhttp.status == 200) {
                log(xmlhttp.responseText);      
            }
        }

        function get_patterns() {
            if (patterns != null)
                return;
            xmlhttp.open('GET', patternsUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200) {
                patterns = eval("("+xmlhttp.responseText+")");
                //log(xmlhttp.responseText);      
                update_patterns_div(patterns);
            }
        }
        function add_pattern(value) {
            xmlhttp.open('POST', patternsUri, false); 
            jsonSerial = JSON.stringify(patterns); 
            log(jsonSerial);
            xmlhttp.send("{'pattern':"+jsonSerial+"}");
        }
        function put_patterns(value) {
            xmlhttp.open('POST', patternsUri, false); 
            jsonSerial = JSON.stringify(patterns); 
            log(jsonSerial);
            xmlhttp.send("{'patterns':"+jsonSerial+"}");
        }

        function get_instruments() {
            xmlhttp.open('GET', instrumentsUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200) {
                instruments = eval("("+xmlhttp.responseText+")");
                update_instruments_div(instruments);
                //log(xmlhttp.responseText);      
            }
        }
        function put_instruments(value) {
            xmlhttp.open('POST', instrumentsUri, false); 
            jsonSerial = JSON.stringify(instruments); 
            log(jsonSerial);
            xmlhttp.send("{'instruments':"+jsonSerial+"}");
        }

        /*function get_global_vol() {
            xmlhttp.open('GET', globalVolUri, false); 
            xmlhttp.send(null);
            if(xmlhttp.status == 200) {
                globalVol = eval("("+xmlhttp.responseText+")");
                log(xmlhttp.responseText);      
                document.getElementById('globalVol').value = globalVol.global_volume;
            }
        }

        function put_global_vol(value) {
            xmlhttp.open('POST', globalVolUri, false); 
            xmlhttp.send(value);
            if(xmlhttp.status == 200) {
                document.getElementById('globalVol').value = value
                log(xmlhttp.responseText);      
            }
        }

        function global_vol_down() {
            newvol = document.getElementById('globalVol').value - 1;
            put_global_vol(newvol);
        }

        function global_vol_up() {
            newvol = document.getElementById('globalVol').value - 1 + 2;
            put_global_vol(newvol);
        } */


        function log(str) {
            console.log(str);
        }

        function update_sequence_div(sequence) {
            var seqdiv = document.getElementById('sequence'),
                seqol,
                li,
                row,
                inp;

            // javascript and closures and scope can stick it's self up it's stupid fucking arse.
            // This works so I'm sticking with it now.
            var update = (function (e) {window.sequence = eval('['+inp.value+']'); put_sequence('['+inp.value+']');});
            inp = document.createElement('input');
            inp.type = 'text';
            inp.value = sequence;
            inp.onchange = update;
            seqdiv.appendChild(inp);


        }

        function showPattern(patternId) {
            var pattsdiv = document.getElementById('patterns');
            console.log("showing pattern " + patternId);
            for (i in pattsdiv.childNodes) {
                if (patterns.hasOwnProperty(i)) {
                    node = pattsdiv.childNodes[i];
                    //log(node);
                    if (node.nodeName=="TABLE") {
                        if (node.id==patternId) {
                            node.setAttribute('style','display:block');
                        }
                        else {
                            node.setAttribute('style','display:none');
                        }

                    }
                }
            }
        }

        function loopPattern (patNo) {
            loopPatternNo = patNo;
            loopPatternPlay(patNo); 
            console.log(patNo);
        }

        function update_instruments_div(instruments) {
            var instselector = document.getElementById('instrumentSelectors'),
                instDiv = document.getElementById('instrumentView'),
                i = null,
                instSpan,
                instView,
                instLink,
                instText;

            if (modglobals == null) {
                load();
            }
            for (i in instruments) {
                if (instruments.hasOwnProperty(i)) {
                    instSpan = document.createElement('span');
                    //instSpan.innerHTML = 'instrument '+i;
                    instLink = document.createElement('span');
                    instLink.setAttribute("class", "instSelector");
                    instText = document.createElement("span");
                    instText.innerHTML = "instrument-" + i + " ";
                    instText.setAttribute("onclick", "showInstrument('"+i+"')");
                    instLink.appendChild(instText);

                    instselector.appendChild(instLink);
                    instDiv.appendChild(instSpan);
                }
            }
        }
        function showInstrument(insNo) {
            var samples = instruments[insNo].samples,
                instSpan,
                i;
            instDiv = document.getElementById('instrumentView');
            cleanElement(instDiv);
            instSpan = document.createElement('span');
            console.log(instruments[insNo].samples[0]);
            for (i in samples) {
                if (samples.hasOwnProperty(i)) {
                    console.log(i);
                }
            }
        }

        function update_patterns_div(patterns) {
            var i;
            if (modglobals == null) {
                load();
            }
            for (i = 0; i < patterns.length; i += 1) {
                renderPatternBlock(i);
            }
        }
        function renderPatternBlock(i) {
            var patselector = document.getElementById('patternSelectors'),
                pattsdiv = document.getElementById('patterns'),
               // i = null,
                patdiv,
                patspan,
                chan,
                row,
                ta,
                tr,
                td,
                patLink,
                patText,
                patPlay;

            patspan = document.createElement('span');
            patspan.innerHTML = 'pattern '+i;
            pattab = document.createElement('table');
            pattab.appendChild(patspan);
            pattab.setAttribute("style", "display:none");
            pattab.setAttribute("id", "patternData_"+i);
            patLink = document.createElement('span');
            patLink.setAttribute("class", "patternSelector");
            patText = document.createElement("span");
            patText.innerHTML = "pattern " + i;
            patText.setAttribute("onclick", "showPattern('patternData_"+i+"')");
            patPlay = document.createElement("span");
            patPlay.innerHTML = " &gt; ";
            patPlay.setAttribute("onclick", "loopPattern('"+i+"')");
            patPlay.setAttribute("onhover", "loopPattern('"+i+"')");
            patLink.appendChild(patText);
            patLink.appendChild(patPlay);

            //patLink.innerHTML = "pattern "+i;
            //patLink.setAttribute("onclick", "showPattern('patternData_"+i+"')");
            //console.log(i);
            //console.log(patterns[i]);

            for (row = 0; row < patterns[i].numRows; row += 1) {
                tr = document.createElement('tr');
                for (chan = 0; chan < modglobals.numChannels; chan += 1) { 
                    td = getRow(i, patterns[i].data, row, chan, modglobals.numChannels);
                    td.id = "cell_"+ i + "_" + row + "_" + chan;
                    td.onchange = noteChange;
                    tr.appendChild(td);
                }
                pattab.appendChild(tr);
            }
            patselector.appendChild(patLink);
            pattsdiv.appendChild(pattab);
        }


        function getRow(patno, pattern, rowNum, chanNum, numChannels) {
            var chans = null,
                res = "",
                count = 0,
                i = 0,
                row = null,
                td = document.createElement('td'),
                note = document.createElement('input'),
                inst = document.createElement('input'),
                vol = document.createElement('input'),
                eff = document.createElement('input'),
                effval = document.createElement('input');


            //row = pattern.slice(row, numChannels + row);
            rowidx = (rowNum * numChannels) + chanNum;
            row = pattern[rowidx];

            //td.setAttribute('onChange', "noteChange(window.event, " + patno + ", " + chanNum + ", " + rowidx + ");");
            //td.setAttribute('onChange', "noteChange();");

            note.type = 'type';
            note.size = 3;
            note.value = getNote(row);
            note.className = 'note';

            inst.type = 'type';
            inst.size = 2;
            inst.value = getInst(row);
            inst.className = 'inst';

            vol.type = 'type';
            vol.size = 3;
            vol.value = getVol(row);
            vol.className = 'vol';

            eff.type = 'type';
            eff.size = 1;
            eff.value = getEff(row);
            eff.className = 'eff';

            effval.type = 'type';
            effval.size = 2;
            effval.value = getEffVal(row);
            effval.className = 'effval';

            td.appendChild(note);
            td.appendChild(inst);
            td.appendChild(vol);
            td.appendChild(eff);
            td.appendChild(effval);

            return td;
        }

        function getChannel(pattern, chan) {
            var chans = null,
                res = "",
                count = 0,
                i = 0;

            for (i = 0; i < pattern.length; i += 1) {

                row = pattern[i][chan];
                res += getNote(row);
                res += " ";
                res += getInst(row);
                res += " ";
                res += getVol(row);
                res += " ";
                res += getEff(row);
                res += getEffVal(row);
                
                res += "\n";
            }
            log(chan);
            log(res);
            return res;
        }

        function getNote(row) {
            var int = row[0],
                ret = "";
            if (int == 97) {
                return "---";
            }
            ret += NOTES[int % 12];
            ret += Math.floor(int / 12);
            return ret;
        }
        function getInst(row) {
            return rightjustify(row[1].toString(16), 2);
        }
        function getVol(row) {
            return rightjustify(row[2], 3);
        }
            
        function rightjustify(value, places) {
            var ret = "";
            ret = value + "";
            if (ret.length < 2) {
                ret = "." + ret;
            }
            if (ret.length < 3) {
                ret = "." + ret;
            }
            return ret.substring(3 - places);
        }
        function getEff(row) {
            return row[3];
        }
        function getEffVal(row) {
            var int = row[4],
                ret = "";
            ret = int + "";
            if (ret.length < 2) {
                ret = "0" + ret;
            }
            return ret;
        }

        function totalChannels(patterns) {
            // TODO: do some work here to get the acutal number of channels.
            return 6;
        }

        var NOTES = ["..", "C-", "C#", "D-", "D#", "E-", "F-","F#", "G-", "G#", "A-", "A#", "B-"];

        //function noteChange (val, pat, row, chan) {
        function noteChange (evt) {
            var bits, pat, row, chan, dataidx, celldiv;

            evt = evt || window.event;
            log(evt);
            bits = evt.currentTarget.id.split('_');
            pat = bits[1];
            row = bits[2];
            chan = bits[3];
            //celldiv = document.getElementById(evt.currentTarget.id),
            dataidx = parseInt((row * patterns[pat].numRows) + chan);

            if (evt.target.className == "note") {
                patterns[pat].data[dataidx][0] = evt.target.value.replace(".","");
            }
            if (evt.target.className == "inst") {
                patterns[pat].data[dataidx][1] = parseInt(evt.target.value.replace(".",""));
            }
            if (evt.target.className == "vol") {
                patterns[pat].data[dataidx][2] = parseInt(evt.target.value.replace(".",""));
            }
            if (evt.target.className == "type") {
                patterns[pat].data[dataidx][3] = parseInt(evt.target.value.replace(".",""));
            }
            if (evt.target.className == "effval") {
                patterns[pat].data[dataidx][4] = parseInt(evt.target.value.replace(".",""));
            }
            put_pattern(pat, patterns[pat]);
            
            //log(pat + " " + row + " " + chan);
            //log(window.event);
            //log(val);
        }

        function put_pattern(pat, value) {
            xmlhttp.open('POST', patternUri+"/"+pat, false); 
            log(value);
            xmlhttp.send(JSON.stringify(value));
            if(xmlhttp.status == 200) {
                log(xmlhttp.responseText);      
            }

            //jsonSerial = JSON.stringify(patterns); 
            //xmlhttp.send(value);

            //send = arrayStr; //"[" + window.sequence.join(",") + "]";
            //xmlhttp.send(send);
            //alert("sending"+arrayStr);
        }


        function cleanElement(node) {
            while (node.hasChildNodes()) {
                node.removeChild(node.lastChild);
            }
        }
        return init;
        }());
</script>
    <body onLoad="init();"> 
        <div id='title'>NeuralyteTracker v0.1.0 <span id='working'></span></div>
        <div id='modBrowser'>
            load from: <input id='loadURL' type="text" size="25" value="http://modarchive.org/data/downloads.php?moduleid=122252#caustic_platform.mod"/>
                <a href='#' class='but' onClick='neuralyteTracker.load("loadURL");'>load</a> or 
                    <a href='#' class='but' onClick='neuralyteTracker.new();'>new</a> <br/>
            <a href='#' id='saveURL' type='text' class='but' onClick='neuralyteTracker.save("saveURL");'>save</a>
            <a href='#' id='putMod' type='text' class='but' onClick='neuralyteTracker.putMod("");'>pushJsong</a>
            <a href='#' type='text' class='but' onClick='neuralyteTracker.updateUI("");'>updateUI</a>
        </div>
        <span id='rendercontrols'>
            <a href='#' class='but' id='playbutton' onClick='neuralyteTracker.play();'>play</a><br/>
            <a href='#' class='but' id='stopbutton' onClick='neuralyteTracker.pause();'>pause</a><br/>
            <a href='#' class='but' id='stopbutton' onClick='neuralyteTracker.restart();'>restart</a><br/>
            </span>
            <div id='modMetadata'> mod name: <input id='songName' type='text' size='25' onkeypress="neuralyteTracker.updateMod(event)"/></br>
            gain: <input id='gain' type='text' size='5' onkeypress="neuralyteTracker.updateMod(event)"/></br>
            defaultSpeed: <input id='defaultSpeed' type='text' size='5' onkeypress="neuralyteTracker.updateMod(event)"/></br>
            defaultTempo: <input id='defaultTempo' type='text' size='5' onkeypress="neuralyteTracker.updateMod(event)"/>

        </div>
        <div id='instruments'>
            <div id='instrumentView'></div><div id='sampleView'></div>
        </div>
        <div id='patternView'></div>



        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <!--input id="uploadWav" type="file" name="wav Load" onchange="neuralyteTracker.loadWavFile();" /-->
        <br/>

        <span id='trackerUI'>
            tune: 
            <input id='tuneUri' type="text" size="25" value="http://modarchive.org/data/downloads.php?moduleid=122252#caustic_platform.mod"> 
            <span class='but' onClick='load();'>load</span> 
            <span class='but' onClick='get_jsong();'>download as jsong</span>
            save:
            <input id='saveUri' type="text" size="35" value="Saving target hard coded to drainpipe.iriscouch.com."> 
            <span class='but' onClick='save();'>save</span><br/>


            <span id='songControls'>
                <span class='but' onClick='play();'>play</span>
                <span class='but' onClick='restart();'>restart</span>
                <span class='but' onClick='stop();'>stop</span><br/><br/>
                <!-- <span class='but' onClick='get_global_vol();'>get_global_vol</span>
                <input id='globalVol' type="text" size="2" value="??">
                <span class='but' onClick='global_vol_up();'>vol_up</span>
                <span class='but' onClick='global_vol_down();'>vol_down</span> -->
                <span class='but' onClick='get_sequence();'>get_sequence</span>
                <!--<span class='but' onClick='put_sequence();'>put_sequence</span>-->
                <span class='but' onClick='get_patterns();'>get_patterns</span>
                <span class='but' onClick='add_patterns();'>add_pattern</span>
                <!--<span class='but' onClick='put_patterns();'>put_patterns</span>-->
                <span class='but' onClick='get_instruments();'>get_instruments</span>
                <span id='sequence'/>
                    <div id='patternSelectors'></div>
                    <div id='patterns'></div>
                    <div id='instrumentSelectors'></div>
                    <!--div id='instrumentView'></div-->
                </span>
            </span>
        </span>


        <div id='documentation'>
        <h2>Doc</h2>

        The source is the documentation. 

        I couldn't get a webserver configured to serve static pages so i've hacked it to lookup this page.<p/>
        Currently supported endpoints - all assume /drainpipe/&lt;encoded uri to mod&gt;/

        <table>
            <tr><th>name</th><th>GET</th><th>POST</th><th>CREATE</th><th>DELETE</th><th>notes</th></tr>
            <tr><td>play</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>save</td><td>X</td><td></td><td></td><td></td><td>saves jsong to doc-store (iriscouch.com)</td></tr>
            <tr><td>restart</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>stop</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>global_volume</td><td>X</td><td>X</td><td></td><td></td><td>This is a setup value for the mod. If you alter this value, you need to restart the tune to hear the effect.</td></tr>
            <tr><td>sequence</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>patterns</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>instruments</td><td>X</td><td>TODO</td><td></td><td></td><td></td></tr>
            <tr><td>samples</td><td>X</td><td>TODO</td><td></td><td></td><td>Samples included in instruments.</td></tr>

        </table>

<script>
</script>

        <h3>END DOC</h3>

        <h3>FAQ</h3>
        
        <h4>Q: Where can I get help?</h4>
        A: You can find me, you can email me. If I get enough emails I'll set up a mailing list. Or maybe a thread on <a href='http://www.pouet.net/'>pouet.net</a> will suffice.

		...

    </div>
    </body>
</html>
