<!-- 
    Project Drainpipe: A RESTful sound tracker
    Copyright (C) 2012,2013  Richard Henwood rjhenwood@yahoo.co.uk

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
    <meta charset="UTF-8">
    <script language='javascript' src="https://raw.github.com/oampo/audiofile.js/master/audiofile.js"></script>

    <style type="text/css">
        div {
            padding: 2px;
            margin-top: 20px;
        }
        #debug {
            background-color: yellow;
            width: 100px;
            float: left;
        }
        #title {
            height: 20px;
        }
        #working {
            display: inline-block;
            width: 140px;
        }
        #patterns {
            width: 100%;
            float: left;
            background-color: #ddddff;
            display: block;
        }
        #patterns table {
            border: 10px;
            width: 100%;
        }
        #patterns tr td {
            padding: 0px;
            border: 0px;
        }
        #rendercontrols {
            background-color: #88ff00;
            float: left;
            width: 100px;
        }
        #modbrowser {
            width: 200px;
            float: left;
            background-color: #00ff00;
        }
        #documentation {
            width: 100%;
            display: block;
            float: left;
        }       
        #trackerUI {
            width: 100%;
            height: 500px;
            display: block;
            float: left;
        }       
        #instruments {
            width: 700px;
            float: left;
            display: block;
            background-color: #ffdddd;
            height: 200px;
        }
        #instrumentView {
            margin-top: -10px;
            width: 200px;
            float: left;
            overflow: auto;
            height: 200px;
        }
        #patternView {
            width: 100%;
            float: left;
            display: block;
            overflow: auto;
            #height: 200px;
        }
        #sampleView {
            margin-top: -20px;
            width: 400px;
            float: right;
            overflow: auto;
            height: 200px;
            background-color: #ffcccc;
        }
        #modMetadata {
            width: 250px;
            float: left;
            background-color: #ff88ff;
        }
        .spanlabel {
            #border: 1px solid gray;
            display: inline-block;
            left: 10px;
            position: relative;
            top: -20px;
            background-color: inherit;
        }
        .note {
            color: purple;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .inst {
            color: green;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .vol {
            color: yellow;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .eff {
            color: black;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .effval {
            color: red;
            background-color: #d8da3d;
            padding: 0px;
            border: 0px;
            font-family: monospace;
            size: 3;
        }
        .but {
            background-color: #ffddff;
            border: 0px;
            padding: 0px;
        }
        .patternSelector {
            background-color: #ddffdd;
            border: 5px;
            padding: 5px;
        }
  </style>

    <script type="text/javascript">
        function init() {
            console.log("loading browser");
        }

        function load(evt) {
            nt.handleFileSelect(evt);
        }

        var neuralyteTracker = (function() {
            mod = null;
            //var mod = null; //uncomment this to make it private
            var readURL = null;
            var xmlhttp = new XMLHttpRequest();
            var targetpath = null;
            var apiName = "";
            var apiRoot = document.location.href.split("#")[0];
            var writeRoot = document.location.href.split("#")[0];
            var readRoot = document.location.href.split("#")[0];
            var NOTES = ["..", "C-", "C#", "D-", "D#", "E-", "F-","F#", "G-", "G#", "A-", "A#", "B-"];

            return {
                init: function() {
                    if (window.File && window.FileReader && window.FileList && window.Blob) {
                        // Great success! All the File APIs are supported.
                        console.log('The File APIs are fully supported in this browser.');
                        document.getElementById('files').addEventListener('change', handleFileSelect, false);
                    } else {
                        alert('The File APIs are not fully supported in this browser.');
                    }
                },
                new: function() {
                    startWorking();
                    newRoot = apiRoot+"/new/new";
                    xmlhttp.open('GET', newRoot, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        console.log("new jsong created");
                        console.log(xmlhttp.responseText);
                        targetpath = eval("("+xmlhttp.responseText+")").saveLocation;
                        mod = null;
                    }
                    else {
                        console.log("can not create new jsong");
                    }
                    document.getElementById('loadURL').value = targetpath;
                    this.load('loadURL');
                    console.log("load complete");
                    stopWorking();
                },
                load: function(id) {
                    startWorking();
                    readURL = document.getElementById(id).value;
                    console.log("loading: " + readURL);  
                    targetpath = readURL;
                    apiName = encodeURIComponent(readURL);
                    readRoot = apiRoot+"/"+apiName+"";
                    xmlhttp.open('GET', readRoot, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        mod = eval("("+xmlhttp.responseText+")");
                    }
                    else {
                        console.log("can't load");
                    }
                    console.log("load complete");
                    stopWorking();
                    updateUI(mod);
                },
                save: function(storeURL) {
                    startWorking();
                    var storeURL = apiRoot+"/" + apiName + "/save";
                    console.log("saving: " + storeURL);  
                    xmlhttp.open('GET', storeURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200) {
                        console.log(xmlhttp.responseText);
                        targetpath = eval("("+xmlhttp.responseText+")").saveLocation;
                    }
                    else {
                        console.log("can not create new jsong");
                    }
                    stopWorking();
                },
                saveJsong: function() {
                    window.open( "data:text/json;charset=utf-8," + escape(JSON.stringify(mod)))
                },
                play: function() {
                    var playURL = apiRoot+"/" + apiName + "/play";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("playing: " + playURL);  
                },
                pause: function() {
                    var playURL = apiRoot+"/" + apiName + "/stop";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("stopped: " + playURL);  
                },
                restart: function() {
                    var playURL = apiRoot+"/" + apiName + "/restart";
                    xmlhttp.open('GET', playURL, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log("stopped: " + playURL);  
                },
                loopPattern: function(evt, patNo) {
                    var loopUri = apiRoot+'/' + apiName + "/pattern/" + patNo + "/play";
                    xmlhttp.open('GET', loopUri, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log(loopUri);      
                },
                updateUI: function() {
                    startWorking();
                    updateUI(mod);
                    stopWorking();
                },
                getStatus: function() {
                    var statusUri = apiRoot+'/' + apiName + "/status";
                    xmlhttp.open('GET', statusUri, false); 
                    xmlhttp.send(null);
                    if(xmlhttp.status == 200)
                        console.log(statusUri);      
                    currentStatus = eval("("+xmlhttp.responseText+")");
                },
                updateMod: function(evt) {
                   if (evt.keyCode == 13) {
                       mod[evt.target.id] = document.getElementById(evt.target.id).value;
                       if (evt.target.id == 'sequence') {
                           console.log('making sequence an array');
                           mod[evt.target.id] = eval('['+mod[evt.target.id]+']');
                           //mod.sequenceLength = mod[evt.target.id].length;
                       }
                       neuralyteTracker.putMod();
                   }
                },
                putMod: function() {
                    startWorking();
                    putModURL = apiRoot+"/" + apiName + "/save";
                    xmlhttp.open('POST', putModURL, false); 
                    xmlhttp.send(JSON.stringify(mod));
                    if(xmlhttp.status == 200)
                        console.log(putModURL);      
                    modglobals = eval("("+xmlhttp.responseText+")");
                    console.log(modglobals);
                    stopWorking();
                },
                renderInstrument: function(instNo) {
                    var inst = mod.instruments[instNo];
                    if (typeof inst == 'undefined') {
                        inst = mod.instruments[0];
                        inst.samples = Array(newSample(null, 'new sample'));
                        mod.instruments[instNo] = inst;
                    }
                    console.log(inst);
                    var instSpan = document.getElementById('inst_'+instNo);
                    var sampView = document.getElementById('sampleView');
                    if (inst.samples.length == 0) {
                        this.renderSample(instNo, 0);
                    }
                    else {
                        for (var i = 0; i < inst.samples.length; i += 1) {
                            console.log('rendering sample: ' + i);
                            this.renderSample(instNo, i);
                        }
                    }
                },
                renderSample: function(instNo, sampNo) {
                    var samp = mod.instruments[instNo].samples[sampNo];
                    var sampView = document.getElementById('sampleView');
                    while (sampView.hasChildNodes()) {
                        sampView.removeChild(sampView.lastChild);
                    }
                    var sampSpan = document.createElement('span');
                    sampSpan.id = 'samp_'+instNo+'_'+sampNo;
                    sampView.appendChild(sampSpan);

                    if (!('sampleData' in samp)) {
                        console.log('no sample data, initializing.');
                        var initSize = 1000;
                        samp.sampleData = new Array(initSize);
                        while (--initSize >= 0) {
                            samp.sampleData[initSize] = 0;
                        }

                    }
                    var sampCanvas = document.createElement('canvas');
                    sampCanvas.setAttribute('height', 100);
                    sampCanvas.setAttribute('width', 300);
                    sampCanvas.id = 'samp_' + instNo + '_'+sampNo + '_canvas';
                    sampSpan.appendChild(sampCanvas);
                    drawSample(sampCanvas.getContext('2d'), samp.sampleData);

                    var sampUpload = document.createElement('input');
                    sampUpload.id = 'samp_'+instNo+'_'+sampNo+'_upload';
                    sampUpload.type = 'file';
                    sampUpload.onchange = loadWavFile;

                    var relNoteText = document.createTextNode("relNote");
                    var relNote = document.createElement('input');
                    relNote.value = samp.relNote;
                    relNote.size = 5;
                    relNote.onchange = (function(x) {
                            // this updates the server with the new values.
                            samp.relNote = parseInt(x.target.value);
                            var n = x.target.parentElement.id.split('_'); 
                            console.log(samp);
                            neuralyteTracker.putSample(n[1], n[2], mod.instruments[n[1]].samples[n[2]]);
                    });
                    var c2RateText = document.createTextNode("c2Rate");
                    var c2Rate = document.createElement('input');
                    c2Rate.value = samp.c2Rate;
                    c2Rate.size = 5;
                    c2Rate.onchange = (function(x) {
                            // this updates the server with the new values.
                            samp.c2Rate = parseInt(x.target.value);
                            var n = x.target.parentElement.id.split('_'); 
                            console.log(mod);
                            neuralyteTracker.putSample(n[1], n[2], mod.instruments[n[1]].samples[n[2]]);
                    });

                    sampSpan.appendChild(sampUpload);
                    sampSpan.appendChild(relNoteText);
                    sampSpan.appendChild(relNote);
                    sampSpan.appendChild(c2RateText);
                    sampSpan.appendChild(c2Rate);

                    console.log('sample data is ready for drawing.');
                },
                addNewPattern: function(evt) {
                    var numRows = parseInt(prompt("number of rows", 64));
                    var pat = new newPattern(mod.numChannels, numRows, mod.patterns.length);
                    mod.patterns[mod.patterns.length] = pat;
                    updateUI(mod);
                },
                addNewInstrument: function(evt) {
                    var inst = Object.create(mod.instruments[0]);
                    inst.name = prompt("instrument name", "");
                    inst.samples = Array(newSample(null, 'new sample'));
                    mod.instruments[mod.instruments.length] = inst;
                    updateUI(mod);
                },
                renderPattern: function(evt, patNo) {
                    var pat = mod.patterns[patNo];
                    // there is a span already in the pattern
                    // dom object because one is created 
                    // in the 'private' method 'updateUI'.
                    // This design is terriable and should be
                    // fixed.
                    if (typeof pat == 'undefined') {
                        pat = newPattern(mod.numChannels, mod.patterns[0].numRows, patNo);
                        mod.patterns[patNo] = pat;
                    }
                    var patSpan = document.getElementById('pat_' + patNo);
                    console.log("rendering pattern: " + patNo);
                    var numRowstext = document.createTextNode("number of rows");
                    var numRows = document.createElement('input');
                    numRows.value = pat.numRows;
                    numRows.size = 5;
                    numRows.onchange = (function(x) {
                            // this updates the server with the new values.
                            pat.numRows = parseInt(x.target.value);
                            var n = x.target.parentElement.id.split('_'); 
                            console.log(mod);
                            neuralyteTracker.putPattern(patNumber, pat);
                    });
                    var patTable = document.createElement('table');
                    patTable.id = "pat_"+patNo+"_table";
                    for (var row = 0; row < pat.numRows; row += 1) {
                        var tr = document.createElement('tr');
                        var rowtd = document.createElement('td');
                        rowtd.class = 'pat_row';
                        rowtd.innerHTML = row.toString(16);
                        tr.appendChild(rowtd);
                        for (var chan = 0; chan < mod.numChannels; chan += 1) { 
                            var td = getRow(patNo, pat, row, chan, mod.numChannels);
                            td.id = "cell_"+ patNo+ "_" + row + "_" + chan;
                            td.onchange = this.noteChange;
                            tr.appendChild(td);
                        }
                        patTable.appendChild(tr);
                    }
                    patSpan.appendChild(numRowstext);
                    patSpan.appendChild(numRows);
                    patSpan.appendChild(patTable);
                    var patExpander = document.getElementById('pat_' + patNo+'_expander');
                    var aRemovePattern = document.createElement('a');
                    aRemovePattern.href = '#';
                    aRemovePattern.innerHTML = '-';
                    aRemovePattern.setAttribute('onclick', 'neuralyteTracker.removePattern(event,'+patNo+'); return false;');
                    patExpander.appendChild(aRemovePattern);
                    console.log(patExpander);
                },
                removePattern: function (evt, patNo) {
                    var patTable = document.getElementById('pat_' + patNo +'_table');
                    patTable.parentNode.removeChild(patTable);
                    var patExpander = document.getElementById('pat_' + patNo+'_expander');
                    var aRemovePattern = document.createElement('a');
                    aRemovePattern.href = '#';
                    aRemovePattern.innerHTML = '+';
                    aRemovePattern.setAttribute('onclick', 'neuralyteTracker.renderPattern(event,'+patNo+') return false;');
                    patExpander.appendChild(aRemovePattern);
                    console.log(patExpander);
                },
                noteChange: function (evt) {
                    var bits, pat, row, chan, dataidx, celldiv;

                    evt = evt || window.event;
                    console.log(evt);
                    //console.log(evt.currentTarget.childNodes[0].value);
                    bits = evt.currentTarget.id.split('_');
                    pat = bits[1];
                    row = bits[2];
                    chan = bits[3];
                    dataidx = parseInt((row * mod.numChannels) + parseInt(chan));

                    console.log("before:");
                    console.log("row: " + row + " pat: " + pat + " chan: " + chan + " dataidx: " + dataidx);
                    console.log(mod.patterns[pat].data[dataidx]);
                    mod.patterns[pat].data[dataidx] = eval("new Array("+evt.currentTarget.childNodes[0].value+");");
                    //mod.numPatterns = Math.max(mod.numPatterns, parseInt(pat) + 1);
                    console.log("after :");
                    console.log(mod.patterns[pat].data[dataidx]);
                    neuralyteTracker.putPattern(pat, mod.patterns[pat]);
                    
                    // this is the pretty way to render the cell elements:
                    //celldiv = document.getElementById(evt.currentTarget.id),
                    //if (evt.target.className == "note") {
                    //    mod.patterns[pat].data[dataidx][0] = evt.target.value.replace(".","");
                    //}
                    //if (evt.target.className == "inst") {
                    //    mod.patterns[pat].data[dataidx][1] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //if (evt.target.className == "vol") {
                    //    mod.patterns[pat].data[dataidx][2] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //if (evt.target.className == "type") {
                    //    mod.patterns[pat].data[dataidx][3] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //if (evt.target.className == "effval") {
                    //    mod.patterns[pat].data[dataidx][4] = parseInt(evt.target.value.replace(".",""));
                    //}
                    //neuralyteTracker.putPattern(pat, mod.patterns[pat]);
                },
                putPattern: function (patNo, patDat) {
                    startWorking();
                    var putPatURL = apiRoot+"/" + apiName + "/pattern/" + patNo;
                    xmlhttp.open('POST', putPatURL, false); 
                    xmlhttp.send(JSON.stringify(patDat));
                    if(xmlhttp.status == 200)
                        console.log(putPatURL);      
                    //modglobals = eval("("+xmlhttp.responseText+")");
                    console.log("pattern updated");
                    stopWorking();
                },
                putSample: function (instNo, sampNo, sampDat) {
                    startWorking();
                    console.log(sampDat);
                    var putSampURL = apiRoot+"/" + apiName + "/instrument/" + instNo + "/sample/" + sampNo;
                    xmlhttp.open('POST', putSampURL, false); 
                    xmlhttp.send(JSON.stringify(sampDat));
                    if(xmlhttp.status == 200)
                        console.log(putSampURL);      
                    //modglobals = eval("("+xmlhttp.responseText+")");
                    console.log("sample updated");
                    stopWorking();
                }
            }
            function loadWavFile (evt) {
                if (document.getElementById(evt.target.id).files.length === 0) { return; }
                var oFile = document.getElementById(evt.target.id).files[0];
                var objectURL = window.URL.createObjectURL(oFile);
                var reader = new FileReader();
                reader.file = oFile;
                reader.onload = function (e) {
                    var file = this.file;
                    var decoder = new WAVDecoder();
                    var decoded = decoder.decode(e.target.result);
                    var scale = Math.pow(2, decoded.bitDepth)/2.0; // divide by to because we are using signed ints.
                    var modInst = new Array(decoded.length);
                    for (var i = 0; i < decoded.length; i += 1) {
                        modInst[i] = Math.round(decoded.channels[0][i]*scale);
                    }
                    console.log(file);
                    setNewSample(modInst, evt.target.id, file.name, 8363, 0);
                }
                reader.readAsBinaryString(oFile);
            }

            function setNewSample(dat, idstr, name, c2Rate, relNote) {
                var n = idstr.split('_');
                var sampJson = {'name': name,
                    'c2Rate': c2Rate,
                    'fineTune': 0,
                    'loopLength': 0,
                    'loopStart': dat.length - 1,
                    'panning': 128,
                    'relNote': relNote,
                    'sampleData': dat,
                    'volume': 64};
                mod.instruments[n[1]].samples[n[2]] = sampJson;
                var sampCanvas = document.getElementById(n[0] +"_"+ n[1] +"_"+ n[2] +'_canvas');
                //console.log(mod.instruments[n[1]].samples[n[2]][0].sampleData);
                console.log('new sample data is set. inst ' + n[1] + ' sample ' + n[2]);
                drawSample(sampCanvas.getContext('2d'), dat);
                neuralyteTracker.putSample(n[1], n[2], sampJson);
            }
            function newSample (dat, name) {
                if (dat == null)
                    return {'name': name,
                        'c2Rate': 8363,
                        'fineTune': 0,
                        'loopLength': 0,
                        'panning': 128,
                        'relNote': 0,
                        'volume': 64};
                return {'name': name,
                    'c2Rate': 8363,
                    'fineTune': 0,
                    'loopLength': 0,
                    'loopStart': dat.length - 1,
                    'panning': 128,
                    'relNote': 0,
                    'sampleData': dat,
                    'volume': 64};
            }
            function drawSample(ctx, sampData) {
                var i = 0,
                    width = ctx.canvas.width,
                    height = ctx.canvas.height,
                    points = sampData.length,
                    pointspx = width/points;

                ctx.clearRect(0, 0, width, height);
                ctx.beginPath();
                ctx.strokeStyle = '"rgb(255,165,0)";';
                ctx.moveTo(0,0);
                ctx.moveTo(0,height/2+((height*sampData[0])/65534.0));
                for (var pt = 1; pt < points; pt += Math.ceil(points/1000)) {
                    ctx.lineTo(pt*(width/points), height/2+((height*sampData[pt])/65534.0));
                }
                ctx.stroke();
                ctx.closePath();

                console.log('drawn.');
            }

            function startWorking() {
                var image = document.createElement('img');
                image.src = "http://imageshack.us/scaled/landing/691/throbber.gif";
                document.getElementById('working').appendChild(image);
            }
            function stopWorking() {
                var node = document.getElementById('working');
                var targetpathspan = document.getElementById('targetpath');
                targetpathspan.innerHTML = targetpath;
                rmChildren(node);
            }
            function rmChildren(node) {
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
            }
            function updateUI(mod) {
                for (var key in mod) {
                    if (mod.hasOwnProperty(key)) {
                        var node = document.getElementById(key);
                        if (node != null) {
                            node.value = mod[key];
                        }
                    }
                }
                var patternView = document.getElementById('patternView');
                rmChildren(patternView);
                for (var i = 0; i < mod.patterns.length; i+=1) {
                    patternView.appendChild(getPatSpan(mod.patterns[i], "pat "+i));
                }

                var instrumentView = document.getElementById('instrumentView');
                rmChildren(instrumentView);
                var i;
                for (i = 1; i < mod.instruments.length; i += 1) {
                    var inst = mod.instruments[i];
                    instrumentView.appendChild(getInstSpan(inst, i, rightjustify(i,2)+" "+inst.name));
                }
            }
            function getPatSpan(pat, patName) {
                var i = pat.patNumber;
                var patSpan = document.createElement('span');
                patSpan.id = 'pat_'+i;

                var patText = document.createTextNode(patName);
                var patA = document.createElement('a');
                patA.href = '#';
                patA.innerHTML = '+';
                patA.id = 'pat_'+pat.patNumber+'_expander';
                patA.setAttribute('onclick', 'neuralyteTracker.renderPattern(event,'+i+'); return false;');
                var patB = document.createElement('a');
                patB.href = '#';
                patB.innerHTML = '>';
                patB.setAttribute('onclick', 'neuralyteTracker.loopPattern(event,'+i+'); return false;');
                patSpan.appendChild(patText);
                patSpan.appendChild(patA);
                patSpan.appendChild(patB);
                patSpan.appendChild(document.createTextNode('  '));
                //console.log('rendered pattern: ' + i);
                return patSpan;
            }
            function newPattern(channels, rows, patNum) {
                var pat = new Array(channels*rows), 
                    i = 0;
                while (i < (channels * rows)) {
                    pat[i] = [0,0,0,0,0];
                    i += 1;
                }
                return {'numRows': rows, 'patNumber': patNum, 'data': pat};
            }
            function getInstSpan(inst, instNo, instName) {
                var instSpan = document.createElement('div');
                instSpan.id = "inst_"+instNo;
                instSpan.class = 'instClass';
                var instA = document.createElement('a');
                instA.href = "#";
                instA.innerHTML = instName;
                instA.onclick = new Function("neuralyteTracker.renderInstrument("+instNo+"); return false;");
                instSpan.appendChild(instA);
                return instSpan;
            }
            function getRow(patno, pattern, rowNum, chanNum, numChannels) {
                var chans = null,
                res = "",
                count = 0,
                i = 0,
                row = null,
                rowidx,
                td = document.createElement('td'),
                note = document.createElement('input'),
                inst = document.createElement('input'),
                vol = document.createElement('input'),
                eff = document.createElement('input'),
                effval = document.createElement('input');

                rowidx = (rowNum * numChannels) + chanNum;
                row = pattern.data[rowidx];

                var rowinput = document.createElement('input');
                rowinput.value = row;
                rowinput.size = 10;
                //rowinput.onchange = new Function(console.log(rowinput));
                td.appendChild(rowinput)
                return td;

                note.type = 'type';
                note.size = 3;
                note.value = getNote(row);
                note.className = 'note';

                inst.type = 'type';
                inst.size = 2;
                inst.value = getInst(row);
                inst.className = 'inst';

                vol.type = 'type';
                vol.size = 3;
                vol.value = getVol(row);
                vol.className = 'vol';

                eff.type = 'type';
                eff.size = 1;
                eff.value = getEff(row);
                eff.className = 'eff';

                effval.type = 'type';
                effval.size = 2;
                effval.value = getEffVal(row);
                effval.className = 'effval';

                td.appendChild(note);
                td.appendChild(inst);
                td.appendChild(vol);
                td.appendChild(eff);
                td.appendChild(effval);
                return td;
            }
            function getNote(row) {
                var int = row[0],
                    ret = "";
                if (int == 97) {
                    return "---";
                }
                ret += NOTES[int % 12];
                ret += Math.floor(int / 12);
                return ret;
            }
            function getInst(row) {
                return rightjustify(row[1].toString(16), 2);
            }
            function getVol(row) {
                return rightjustify(row[2], 3);
            }
            function rightjustify(value, places) {
                var ret = "";
                ret = value + "";
                if (ret.length < 2) {
                    ret = "." + ret;
                }
                if (ret.length < 3) {
                    ret = "." + ret;
                }
                return ret.substring(3 - places);
            }
            function getEff(row) {
                return row[3];
            }
            function getEffVal(row) {
                var int = row[4],
                    ret = "";
                ret = int + "";
                if (ret.length < 2) {
                    ret = "0" + ret;
                }
                return ret;
            }
        }());

</script>
    <body onLoad="init();"> 
        <div id='title'>NeuralyteTracker v0.1.0 <span id='working'></span>mod target: <span id='targetpath'></span></div>
        <span id='trackerUI'>
        <div id='modBrowser'><span class='spanlabel'>file</span>
            load {xm,s3m,mod,jsong} from: <input id='loadURL' type="text" size="25" value="http://modarchive.org/data/downloads.php?moduleid=122252#caustic_platform.mod"/>
            <a href='#' class='but' onClick='neuralyteTracker.load("loadURL");'>load</a> or 
            <a href='#' class='but' onClick='neuralyteTracker.new();'>new</a> <br/>
            <a href='#' id='saveURL' type='text' class='but' onClick='neuralyteTracker.save("saveURL");'>save</a>
        </div>
        <div id='debug'><span class='spanlabel'>debug</span>
            <a href='#' id='putMod' type='text' class='but' onClick='neuralyteTracker.putMod("");'>pushJsong</a>
            <a href='#' type='text' class='but' onClick='neuralyteTracker.saveJsong("");'>saveJsong</a>
            <a href='#' type='text' class='but' onClick='neuralyteTracker.updateUI("");'>updateUI</a>
            <a href='#' type='text' class='but' onClick='neuralyteTracker.getStatus("");'>get status</a>
        </div>
        <div id='rendercontrols'><span class='spanlabel'>controls</span>
            <a href='#' class='but' id='playbutton' onClick='neuralyteTracker.play();'>play</a><br/>
            <a href='#' class='but' id='stopbutton' onClick='neuralyteTracker.pause();'>pause</a><br/>
            <a href='#' class='but' id='stopbutton' onClick='neuralyteTracker.restart();'>restart</a><br/>
        </div>
        <div id='modMetadata'><span class='spanlabel'>globals</span>
            mod name: <input id='songName' type='text' size='25' onkeypress="neuralyteTracker.updateMod(event)"/></br>
            gain: <input id='gain' type='text' size='5' onkeypress="neuralyteTracker.updateMod(event)"/></br>
            defaultSpeed: <input id='defaultSpeed' type='text' size='5' onkeypress="neuralyteTracker.updateMod(event)"/></br>
            defaultTempo: <input id='defaultTempo' type='text' size='5' onkeypress="neuralyteTracker.updateMod(event)"/>
            sequence: <input id='sequence' type='text' size='15' onkeypress="neuralyteTracker.updateMod(event)"/>
        </div>
        <div id='instruments'><span class='spanlabel'>instruments</span>
            <span><a href='#' onClick='neuralyteTracker.addNewInstrument(); return false;'>add new</a></span>
            <div id='instrumentView'></div>
            <div id='sampleView'></div>
        </div>
        <div id='patterns'><span class='spanlabel'>patterns</span>
            <span><a href='#' onClick='neuralyteTracker.addNewPattern(); return false;'>add new</a></span>
            <div id='patternView'></div>
        </div>

        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <span>

        <span id='documentation'>
        <h2>Doc</h2>

        The source is the documentation. 

        pattern cells are in order, left to right: note, inst, vol, eff, effval.

        I couldn't get a webserver configured to serve static pages so i've hacked it to lookup this page.<p/>
        Currently supported endpoints - all assume /drainpipe/&lt;encoded uri to mod&gt;/

        <table>
            <tr><th>name</th><th>GET</th><th>POST</th><th>CREATE</th><th>DELETE</th><th>notes</th></tr>
            <tr><td>play</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>save</td><td>X</td><td></td><td></td><td></td><td>saves jsong to doc-store (iriscouch.com)</td></tr>
            <tr><td>restart</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>stop</td><td>X</td><td></td><td></td><td></td><td></td></tr>
            <tr><td>global_volume</td><td>X</td><td>X</td><td></td><td></td><td>This is a setup value for the mod. If you alter this value, you need to restart the tune to hear the effect.</td></tr>
            <tr><td>sequence</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>patterns</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>instruments</td><td>X</td><td>X</td><td></td><td></td><td></td></tr>
            <tr><td>samples</td><td>X</td><td>X</td><td></td><td></td><td>Samples included in instruments.</td></tr>

        </table>

<script>
</script>

        <h3>END DOC</h3>

        <h3>FAQ</h3>
        
        <h4>Q: Where can I get help?</h4>
        A: You can find me, you can email me. If I get enough emails I'll set up a mailing list. Or maybe a thread on <a href='http://www.pouet.net/'>pouet.net</a> will suffice.

		...

        The effects are based on XM supported effects. The integer equivilents are:
<pre>

nt, int eqivelent      XM effect
  0                    0xy: Arpeggio                          
  1                    1xy: Portamento Up                     
  2                    2xy: Portamento Down                   
  3                    3xy: Tone-Portamento                   
  4                    4xy: Vibrato                           
  5                    5xy: Tone-Portamento + Volume Slide    
  6                    6xy: Vibrato + Volume Slide            
  7                    7xy: Tremolo                           
  8                    8xy: Set Panning                       
  9                    9xy: Set Sample Offset                 
 10                    Axy: Volume Slide                      
  ?                    Bxy: Position Jump                     
 12                    Cxy: Set Volume                        
  ?                    Dxy: Pattern Break                     
  ?                    Exy: Extended MOD Commands             
  ?                    Fxy: Set Speed/Tempo                   
 16                    Gxy: Set Global Volume
 17                    Hxy: Global Volume Slide
 20                    Kxy: Key Off
 21                    Lxy: Set Envelope Position
 25                    Pxy: Panning Slide
 27                    Rxy: Retrig
 29                    Txy: Tremor
  ?                    Xxy: Extended XM effects
  ?                    Zxy: Macros

? means either I haven't figured it out, or it isn't supported or both.
</pre>


    </span>

    </body>
</html>
